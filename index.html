<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ™ºæ…§è¯çµ¡ç°¿ v20.9ï¼ˆè¿”å›ç·¨è¼¯ï¼‹é€±æ¬¡å¯å¡«å¯«ï¼‰</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        :root{
            --primary-color:#2b7de9;
            --page-bg:#ffffff;
            --card-bg:#ffffff;
            --text-color-primary:#000000;
            --card-border:rgba(0,0,0,.12);
            --shadow-color:rgba(0,0,0,.08);
            --item-font-size:1.9em;
            --control-border-radius:14px;
        }
        *{box-sizing:border-box}
        html,body{height:100%;margin:0}
        body{
            font-family:'Microsoft JhengHei','Noto Sans TC',sans-serif;
            color:var(--text-color-primary);
            background:var(--page-bg);
            padding:30px;
            display:flex;align-items:center;justify-content:center;
            min-height: 100vh; /* ç¢ºä¿å…§å®¹å€åŸŸèƒ½é¡¯ç¤ºå®Œæ•´ */
        }
        .container{max-width:1320px;width:100%}
        .main-header{text-align:center;margin-bottom:20px}
        .main-title{
            font-family:'ZCOOL KuaiLe','Microsoft JhengHei','Noto Sans TC',sans-serif;
            font-size:3em;font-weight:900;
        }
        .card{
            background:var(--card-bg);
            border-radius:24px;
            border:1px solid var(--card-border);
            box-shadow:0 10px 30px var(--shadow-color);
            padding:28px;
            display:flex;
            flex-direction:column;
            min-height:680px;
            max-height:80vh;
        }

        /* æ—¥æœŸ + é€±æ¬¡åˆ— */
        .card-header{
            display:flex;flex-wrap:wrap;gap:12px;
            justify-content:center;align-items:center;
            margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--card-border)
        }
        .nav-date-group{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
        .nav-date-group button{padding:10px 16px;font-size:1.05em}
        /* å„ªåŒ–æ—¥æœŸé¸æ“‡å™¨å’Œé€±æ¬¡é¡¯ç¤º */
        #date-selector{
            background:none;border:none;font-size:2.2em;font-weight:800;cursor:pointer;
            width: 170px; /* çµ¦æ—¥æœŸè¶³å¤ çš„ç©ºé–“ */
            text-align: center;
        }
        #week-display{font-size:1.1em;color:#555}
        .weekno-wrap{display:flex;align-items:center;gap:8px;margin-left:8px}
        .weekno-wrap label{font-weight:700;color:#333}
        #weekno-input{
            width:120px;padding:8px 10px;border-radius:10px;
            border:1px solid rgba(0,0,0,.15); font-size:1em;
            /* å°‡è¼¸å…¥æ¡†æ¨£å¼èª¿æ•´å¾—æ›´åƒé¡¯ç¤ºæ–‡æœ¬ */
            background: rgba(0,0,0,.03);
        }
        #weekno-input:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(43,125,233,.15)}

        /* æ¸…å–® */
        .homework-list{
            list-style:none;padding:0;margin:0;
            display:flex;flex-direction:column;
            gap:6px;
            flex-grow:1;overflow:auto;padding:8px;margin:0 -8px;
        }
        .homework-item{
            display:flex;align-items:flex-start;gap:8px;
            font-size:var(--item-font-size);
            border-radius:var(--control-border-radius);
            padding:10px 12px;
            transition:background-color .2s ease;
            border:1px dashed transparent;
        }
        .homework-item:hover{background-color:rgba(0,0,0,.03)}
        .item-index{color:#555;font-weight:700;margin-top:2px}
        .item-content{flex:1;white-space:pre-wrap;outline:none}
        .delete-item-btn{opacity:0;background:none;border:none;font-size:1.2em;cursor:pointer;color:#777;padding: 0 4px;}
        .homework-item:hover .delete-item-btn{opacity:1}

        /* æ–°å¢è¼¸å…¥åˆ— */
        #homework-input-area{
            display:flex;gap:8px;background:rgba(0,0,0,.05);
            border-radius:var(--control-border-radius);
            padding:10px;border:1px solid rgba(0,0,0,.08);
            margin-top:14px;
        }
        #new-homework-input{
            flex:1;padding:10px 12px;font-size:1.2em;
            border-radius:10px;border:1px solid rgba(0,0,0,.15);
        }
        #new-homework-input:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(43,125,233,.2)}
        .add-btn{background:var(--primary-color);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}

        /* æŒ‰éˆ•åˆ— - RWD å¼·åŒ– */
        .footer-buttons{
            display:grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap:10px;margin-top:16px;
        }
        button{border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
        .btn-primary{background:var(--primary-color);color:#fff}
        .btn-secondary{background:rgba(0,0,0,.05);border:1px solid rgba(0,0,0,.12)}
        .font-slider-container{display:flex;align-items:center;gap:10px;background:rgba(0,0,0,.05);padding:8px 10px;border-radius:10px}
        .color-tools{display:flex;gap:10px;justify-content:center;align-items:center;background:rgba(0,0,0,.05);padding:8px 10px;border-radius:10px}
        .color-tools select,.color-tools input[type=color]{padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,.12); background: #fff;}
        .color-tools select{flex: 1}

        /* ç›´æ›¸æ¨¡å¼ */
        .vertical-mode{flex-direction:row-reverse;align-items:flex-start;overflow-x:auto;overflow-y:hidden;gap:16px}
        .vertical-mode .homework-item{flex-direction:column;min-width:110px;min-height:420px;align-items:stretch;padding:14px}
        .vertical-mode .item-content{writing-mode:vertical-rl;text-align:right}
        .vertical-mode .horizontal-in-vertical{writing-mode:horizontal-tb;display:inline-block}

        /* å±•ç¤ºæ¨¡å¼ï¼šéš±è—éƒ¨åˆ†æ§åˆ¶ã€æ”¾å¤§å­—ç´š */
        .presentation-mode #homework-input-area,
        .presentation-mode .footer-buttons{display:none}
        .presentation-mode .homework-item{background:transparent}
        .presentation-mode .card{max-height:none;min-height:auto}
        .presentation-mode :root{--item-font-size:2.2em}

        /* ç¯„æœ¬è¦–çª— */
        #template-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.3);align-items:center;justify-content:center;z-index:10}
        #template-modal.visible{display:flex}
        .template-card{background:#fff;padding:24px;border-radius:14px;width:90%;max-width:800px; max-height: 90vh; display: flex; flex-direction: column;}
        .category-tabs{display:flex;gap:8px;margin-bottom:10px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,.12);cursor:pointer; flex-shrink: 0;}
        .tab-btn.active{background:var(--primary-color);color:#fff; border-color: var(--primary-color);}
        .templates-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;flex-grow:1; overflow-y:auto; padding: 10px; margin: 0 -10px;}
        .template-item{padding:10px;border:1px solid rgba(0,0,0,.1);border-radius:10px;cursor:pointer; display: flex; justify-content: space-between; align-items: center;}
        .template-item:hover{background:var(--primary-color);color:#fff}
        .template-item.custom{border-color: var(--primary-color); background: rgba(43,125,233,.05);}
        .template-item.custom:hover{background:var(--primary-color);color:#fff}
        .template-item-content{flex-grow: 1; text-align: left;}
        .delete-template-btn{background: none; border: none; color: inherit; font-size: 1.2em; cursor: pointer; opacity: 0.6; padding: 0 4px;}
        .template-item:hover .delete-template-btn{opacity: 1; color: #fff;}
        .template-item.custom:hover .delete-template-btn{color: #fff;}

        /* RWD for mobile */
        @media (max-width: 768px) {
            body { padding: 15px; }
            .main-title { font-size: 2.5em; }
            .card { min-height: 85vh; padding: 18px; }
            .nav-date-group { justify-content: space-between; width: 100%; }
            .nav-date-group button { flex-grow: 1; }
            #date-selector { font-size: 1.8em; }
            .weekno-wrap { margin: 10px 0 0 0; width: 100%; justify-content: center; }
            #weekno-input { flex-grow: 1; }
            .footer-buttons { grid-template-columns: repeat(auto-fit, minmax(45%, 1fr)); }
            .font-slider-container, .color-tools { grid-column: span 2; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-header"><h1 class="main-title">æ™ºæ…§è¯çµ¡ç°¿</h1></div>

        <div class="card" id="main-card">
            <div class="card-header">
                <div class="nav-date-group">
                    <button id="prev-day-btn" class="btn-secondary" aria-label="ä¸Šä¸€æ—¥">â—€ ä¸Šä¸€æ—¥</button>
                    <input type="date" id="date-selector" aria-label="é¸æ“‡æ—¥æœŸ">
                    <button id="next-day-btn" class="btn-secondary" aria-label="ä¸‹ä¸€æ—¥">ä¸‹ä¸€æ—¥ â–¶</button>
                    <div id="week-display" aria-live="polite"></div>
                    <div class="weekno-wrap">
                        <label for="weekno-input">é€±æ¬¡</label>
                        <input type="text" id="weekno-input" placeholder="ä¾‹å¦‚ï¼šç¬¬ 8 é€±" inputmode="text">
                    </div>
                </div>
            </div>

            <ul class="homework-list" id="homework-list" aria-label="è¯çµ¡äº‹é …æ¸…å–®"></ul>

            <div id="homework-input-area">
                <input type="text" id="new-homework-input" placeholder="æ–°å¢äº‹é …..." aria-label="æ–°å¢äº‹é …">
                <button id="add-item-btn" class="add-btn" aria-label="åŠ å…¥äº‹é …">â•</button>
                <button id="show-template-btn" class="btn-secondary" title="å¾ç¯„æœ¬åŠ å…¥" aria-label="å¾ç¯„æœ¬åŠ å…¥">ğŸª„ ç¯„æœ¬</button>
            </div>
        </div>

        <div class="footer-buttons">
            <button id="toggle-vertical-btn" class="btn-secondary" aria-pressed="false">åˆ‡æ›ç›´æ›¸</button>
            <div class="font-slider-container">
                <label for="font-size-slider">å­—ç´š</label>
                <input type="range" id="font-size-slider" min="1.2" max="3.0" step="0.1" value="1.9" aria-label="å­—ç´šå¤§å°">
            </div>
            <div class="color-tools">
                <select id="color-picker" aria-label="å¿«é€Ÿå­—è‰²">
                    <option value="">å­—è‰²</option>
                    <option value="#000000">é»‘è‰²</option>
                    <option value="#d92c2c">ç´…è‰²</option>
                    <option value="#1a73e8">è—è‰²</option>
                    <option value="#188038">ç¶ è‰²</option>
                    <option value="#e37400">æ©™è‰²</option>
                    <option value="#6f42c1">ç´«è‰²</option>
                </select>
                <input type="color" id="color-custom" value="#000000" aria-label="è‡ªè¨‚å­—è‰²">
            </div>
            <button id="copy-text-btn" class="btn-secondary">è¤‡è£½æ–‡å­—</button>
            <button id="copy-prev-btn" class="btn-secondary">è¤‡è£½å‰æ—¥</button>
            <button id="clear-today-btn" class="btn-secondary">ğŸ§¹ æ¸…é™¤ä»Šæ—¥</button> <button id="export-png-btn" class="btn-primary">åŒ¯å‡ºåœ–ç‰‡ï¼ˆå¡ç‰‡ï¼‰</button>
            <button id="export-fullpng-btn" class="btn-secondary">åŒ¯å‡ºåœ–ç‰‡ï¼ˆæ•´é ï¼‰</button>
            <button id="toggle-presentation-btn" class="btn-secondary">å…¨è¢å¹•å±•ç¤º</button>
        </div>
    </div>

    <div id="template-modal">
        <div class="template-card">
            <h2>é¸æ“‡æˆ–å„²å­˜ç¯„æœ¬</h2>
            <div id="save-template-area" style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,.12); display: flex; gap: 8px;">
                <input type="text" id="custom-template-input" placeholder="è¼¸å…¥è‡ªè¨‚ç¯„æœ¬åç¨±" style="flex: 1; padding: 8px 10px; border-radius: 8px; border: 1px solid rgba(0,0,0,.15);">
                <button id="save-custom-template-btn" class="btn-primary" style="flex-shrink: 0;">ğŸ’¾ å„²å­˜</button>
            </div>
            <div id="category-tabs" class="category-tabs"></div>
            <div id="templates-grid" class="templates-grid"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const $ = s => document.querySelector(s), $$ = s => Array.from(document.querySelectorAll(s));
            const today = new Date(), pad = n => String(n).padStart(2, '0');
            let currentDate = `${today.getFullYear()}-${pad(today.getMonth() + 1)}-${pad(today.getDate())}`;

            // è³‡æ–™çµæ§‹åˆå§‹åŒ–
            let allData = {};
            let customTemplates = {}; // æ–°å¢ï¼šç”¨æ–¼å„²å­˜ä½¿ç”¨è€…è‡ªè¨‚ç¯„æœ¬
            try {
                const data = JSON.parse(localStorage.getItem('ultraContactBook_v20_final') || '{}') || {};
                allData = data.allData || {};
                customTemplates = data.customTemplates || {};
            } catch (e) {
                allData = {};
                customTemplates = {};
            }

            let isVertical = false;
            let isPresentation = false;

            const dateSelector = $('#date-selector');
            const weekDisplay = $('#week-display');
            const weeknoInput = $('#weekno-input');
            const list = $('#homework-list');
            const input = $('#new-homework-input');
            const prevBtn = $('#prev-day-btn');
            const nextBtn = $('#next-day-btn');
            const presentationBtn = $('#toggle-presentation-btn');
            const clearTodayBtn = $('#clear-today-btn'); // æ¸…é™¤æŒ‰éˆ•

            // å…§å»ºç¯„æœ¬ (Built-in Templates)
            const builtInTemplates = {
                "åœ‹èªæ–‡": ["åœ‹ç¿’ L__", "åœ‹èªç¿’ä½œ p.__-__", "ç”²æœ¬ p.__-__", "ç”Ÿå­—æœ¬ L__", "èªè©æœ¬ L__", "é»˜æ›¸ L__", "æ—¥è¨˜"],
                "æ•¸å­¸": ["æ•¸ç¿’ p.__-__", "æ•¸ç·´ ç¬¬__å›", "æ‡‰ç”¨é¡Œ x__"],
                "è‹±èª": ["è‹±ç¿’ U__", "è‹±è½", "å–®å­— U__ å¯«__é", "èª²æ–‡æœ—è®€ U__"],
                "é€šç”¨": ["è€ƒå·è¨‚ç°½", "é ç¿’ L__", "å¸¶__", "è¦ªå­å…±è®€", "é‹å‹•30åˆ†é˜"]
            };
            const getAllTemplates = () => ({
                "è‡ªè¨‚ç¯„æœ¬": customTemplates, // å°‡è‡ªè¨‚ç¯„æœ¬æ”¾åœ¨ç¬¬ä¸€ä½
                ...builtInTemplates
            });

            /* --------- è³‡æ–™æ¨¡å‹å·¥å…· --------- */
            const ensureObjForDate = (d) => {
                const v = allData[d];
                if (Array.isArray(v)) { // èˆŠæ ¼å¼è½‰æ›
                    allData[d] = { items: v.slice(), weekno: "" };
                } else if (!v || typeof v !== 'object') {
                    allData[d] = { items: [], weekno: "" };
                } else {
                    if (!Array.isArray(v.items)) v.items = [];
                    if (typeof v.weekno !== 'string') v.weekno = '';
                }
                return allData[d];
            };
            const getRecord = (d) => ensureObjForDate(d);
            const getItems = () => $$('.item-content').map(e => e.textContent.trim()).filter(Boolean);
            const getWeekno = () => weeknoInput.value.trim();

            const save = () => {
                const rec = ensureObjForDate(currentDate);
                rec.items = getItems();
                rec.weekno = getWeekno();
                localStorage.setItem('ultraContactBook_v20_final', JSON.stringify({
                    allData: allData,
                    customTemplates: customTemplates
                }));
            };

            /* --------- æ—¥æœŸå·¥å…· --------- */
            const fmt = d => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
            const prevDate = s => { let [y, m, dd] = s.split('-').map(Number); let d = new Date(y, m - 1, dd); d.setDate(d.getDate() - 1); return fmt(d); };
            const nextDate = s => { let [y, m, dd] = s.split('-').map(Number); let d = new Date(y, m - 1, dd); d.setDate(d.getDate() + 1); return fmt(d); };
            
            const updateDate = (s) => {
                let d = new Date(s + 'T00:00');
                let w = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][d.getDay()];
                weekDisplay.textContent = `æ˜ŸæœŸ${w}`;
                dateSelector.value = s;
                // è‡ªå‹•æ›´æ–° title
                document.title = `æ™ºæ…§è¯çµ¡ç°¿ (${s} æ˜ŸæœŸ${w})`;
            };

            /* --------- Render --------- */
            const renderList = (arr) => {
                list.innerHTML = '';
                if (!arr || arr.length === 0) { list.innerHTML = `<p style="text-align:center;color:#666;">é»æ“Šä¸‹æ–¹è¼¸å…¥æ¡†æ–°å¢ä»Šæ—¥äº‹é …</p>`; return; }
                arr.forEach((t, i) => {
                    const li = document.createElement('li');
                    li.className = 'homework-item';
                    // ç‚ºäº†åœ¨ç›´æ›¸æ¨¡å¼ä¸­ä¿ç•™æ°´å¹³æ–‡å­—ï¼Œæˆ‘å€‘å°‡ index åŒ…è£¹èµ·ä¾†
                    li.innerHTML = `<span class="item-index horizontal-in-vertical">${i + 1}.</span><span class="item-content" contenteditable="true">${t}</span><button class="delete-item-btn" title="åˆªé™¤">Ã—</button>`;
                    list.appendChild(li);
                });
            };
            const loadDate = (d) => {
                const rec = getRecord(d);
                renderList(rec.items);
                weeknoInput.value = rec.weekno || '';
            };

            /* --------- åˆå§‹åŒ– --------- */
            dateSelector.max = currentDate; // é˜²æ­¢åˆ‡æ›åˆ°æœªä¾†æ—¥æœŸ
            updateDate(currentDate);
            loadDate(currentDate);

            /* --------- æ–°å¢é …ç›® --------- */
            const add = (t) => {
                if (!t.trim()) return;
                const arr = getItems(); arr.push(t.trim());
                renderList(arr); save(); input.value = '';
            };
            $('#add-item-btn').onclick = () => add(input.value);
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.isComposing) {
                    e.preventDefault(); add(input.value);
                }
            });

            /* --------- é …ç›®å…§ Enter å…è¨±æ›è¡Œï¼ˆå·²åœ¨åŸå§‹ç¢¼ä¸­ï¼‰ --------- */
            list.addEventListener('keydown', e => {
                if (e.target.classList.contains('item-content')) {
                    if (e.key === 'Enter' && !e.shiftKey) { 
                        e.preventDefault();
                        document.execCommand('insertLineBreak');
                    }
                }
            });

            /* --------- åˆªé™¤/ç·¨è¼¯å„²å­˜ --------- */
            list.onclick = e => {
                if (e.target.classList.contains('delete-item-btn')) {
                    const idx = $$('.delete-item-btn').indexOf(e.target);
                    const arr = getItems(); arr.splice(idx, 1);
                    renderList(arr); save();
                }
            };
            list.addEventListener('focusout', e => { if (e.target.classList.contains('item-content')) save(); });

            /* --------- æ—¥æœŸåˆ‡æ›ï¼ˆæŒ‰éˆ•èˆ‡é¸æ“‡å™¨ï¼‰ --------- */
            dateSelector.onchange = e => { save(); currentDate = e.target.value; updateDate(currentDate); loadDate(currentDate); };
            prevBtn.onclick = () => { save(); currentDate = prevDate(currentDate); updateDate(currentDate); loadDate(currentDate); };
            nextBtn.onclick = () => { save(); currentDate = nextDate(currentDate); updateDate(currentDate); loadDate(currentDate); };

            /* --------- é€±æ¬¡æ›´æ–° --------- */
            weeknoInput.addEventListener('input', () => save());

            /* --------- æ¸…é™¤ä»Šæ—¥åŠŸèƒ½ --------- */
            clearTodayBtn.onclick = () => {
                if (confirm(`ç¢ºå®šè¦æ¸…é™¤ ${currentDate} çš„æ‰€æœ‰è¯çµ¡äº‹é …å’Œé€±æ¬¡å—ï¼Ÿ`)) {
                    ensureObjForDate(currentDate).items = [];
                    ensureObjForDate(currentDate).weekno = "";
                    renderList([]);
                    weeknoInput.value = "";
                    save();
                    alert('ä»Šæ—¥å…§å®¹å·²æ¸…é™¤ã€‚');
                }
            };

            /* --------- å­—ç´šèˆ‡ç›´æ›¸ï¼ˆä¿ç•™åŸå§‹ç¢¼ï¼‰ --------- */
            $('#font-size-slider').oninput = e => document.documentElement.style.setProperty('--item-font-size', `${e.target.value}em`);
            $('#toggle-vertical-btn').onclick = () => {
                isVertical = !isVertical;
                list.classList.toggle('vertical-mode', isVertical);
                $('#toggle-vertical-btn').setAttribute('aria-pressed', String(isVertical));
                $('#toggle-vertical-btn').textContent = isVertical ? 'åˆ‡æ›æ©«æ›¸' : 'åˆ‡æ›ç›´æ›¸';
            };

            /* --------- å±€éƒ¨å­—è‰²ï¼ˆä¿ç•™åŸå§‹ç¢¼ï¼‰ --------- */
            const applyColor = c => { if (!c) return; document.execCommand('styleWithCSS', false, true); document.execCommand('foreColor', false, c); save(); };
            $('#color-picker').onchange = () => { applyColor($('#color-picker').value); $('#color-picker').value = ''; };
            $('#color-custom').oninput = () => applyColor($('#color-custom').value);

            /* --------- è¤‡è£½æ–‡å­—ï¼ˆä¿ç•™åŸå§‹ç¢¼ï¼‰ --------- */
            $('#copy-text-btn').onclick = async () => {
                const d = new Date(dateSelector.value + 'T00:00');
                const w = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][d.getDay()];
                const wk = getWeekno();
                const header = `${dateSelector.value.replace(/-/g, '/')}ï¼ˆæ˜ŸæœŸ${w}${wk ? `ï¼Œ${wk}` : ''}ï¼‰`;
                const text = header + '\n' + getItems().map((t, i) => `${i + 1}. ${t}`).join('\n');
                try { await navigator.clipboard.writeText(text); alert('å·²è¤‡è£½æ–‡å­—'); } catch { prompt('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š', text); }
            };

            /* --------- è¤‡è£½å‰æ—¥ï¼ˆä¿ç•™åŸå§‹ç¢¼ï¼‰ --------- */
            const findPrevDateWithData = (d, limit = 60) => {
                let cur = d; for (let i = 0; i < limit; i++) { cur = prevDate(cur); const rec = allData[cur]; const items = Array.isArray(rec) ? rec : (rec?.items || []);
                    if (items.length) return cur;
                }
                return null;
            };
            $('#copy-prev-btn').onclick = () => {
                const p = findPrevDateWithData(currentDate, 60);
                if (!p) { alert('æ‰¾ä¸åˆ°å‰æ—¥çš„è¯çµ¡äº‹é …ï¼ˆæœ€è¿‘ 60 å¤©éƒ½æ²’æœ‰è³‡æ–™ï¼‰ã€‚'); return; }
                const prevRec = getRecord(p);
                const prevItems = prevRec.items.slice();
                if (prevItems.length === 0) { alert(`${p} æ²’æœ‰é …ç›®å¯è¤‡è£½ã€‚`); return; }
                const replace = confirm(`æ‰¾åˆ° ${p} çš„ ${prevItems.length} é …ã€‚\n\næŒ‰ã€Œç¢ºå®šã€â†’ è¦†è“‹ä»Šå¤©\næŒ‰ã€Œå–æ¶ˆã€â†’ è¿½åŠ åˆ°ä»Šå¤©å¾Œé¢`);
                const result = replace ? prevItems : [...getItems(), ...prevItems];
                renderList(result); save();
                alert(replace ? 'å·²è¦†è“‹ä»Šæ—¥é …ç›®ã€‚' : 'å·²æŠŠå‰æ—¥é …ç›®è¿½åŠ åˆ°ä»Šå¤©ã€‚');
            };

            /* --------- åŒ¯å‡ºåœ–ç‰‡ï¼ˆä¿ç•™åŸå§‹ç¢¼ï¼‰ --------- */
            const exportImage = async (node, name) => {
                const bar = $('#homework-input-area'); const prev = bar.style.display; bar.style.display = 'none';
                try {
                    const canvas = await html2canvas(node, {
                        scale: 2, useCORS: true, backgroundColor: '#fff', logging: false, onclone: doc => {
                            // å¼·åˆ¶å¯è®€é»‘å­—
                            doc.querySelectorAll('.item-content,.item-index,#week-display,#date-selector,.main-title,label,#weekno-input').forEach(el => {
                                el.style.color = '#000'; if (el.id === 'weekno-input') { el.style.background = '#fff'; el.style.border = '1px solid #0002'; }
                            });
                            // ç§»é™¤è¼¸å…¥åˆ—å’ŒæŒ‰éˆ•åˆ—
                            doc.querySelector('#homework-input-area')?.remove();
                        }
                    });
                    const a = document.createElement('a'); a.download = `${name}.png`; a.href = canvas.toDataURL('image/png'); document.body.appendChild(a); a.click(); a.remove();
                } catch (e) { alert('åŒ¯å‡ºåœ–ç‰‡å¤±æ•—ï¼š' + (e?.message || e)); }
                finally { bar.style.display = prev || ''; }
            };
            $('#export-png-btn').onclick = () => exportImage($('#main-card'), `è¯çµ¡ç°¿_${currentDate}`);
            $('#export-fullpng-btn').onclick = () => exportImage($('.container'), `è¯çµ¡ç°¿æ•´é _${currentDate}`);

            /* --------- ç¯„æœ¬ Modal - æ–°å¢å„²å­˜è‡ªè¨‚ç¯„æœ¬é‚è¼¯ --------- */
            const initTemplateModal = () => {
                const modal = $('#template-modal');
                const showTemplateBtn = $('#show-template-btn');
                const categoryTabs = $('#category-tabs');
                const templatesGrid = $('#templates-grid');
                const saveCustomBtn = $('#save-custom-template-btn');
                const customInput = $('#custom-template-input');

                let currentCategory = Object.keys(builtInTemplates)[0];

                const show = () => modal.classList.add('visible');
                const hide = () => modal.classList.remove('visible');

                // æ¸²æŸ“ç¯„æœ¬åˆ—è¡¨
                const renderGrid = (cat, items) => {
                    templatesGrid.innerHTML = '';
                    const isCustom = cat === "è‡ªè¨‚ç¯„æœ¬";
                    
                    if (isCustom && Object.keys(items).length === 0) {
                        templatesGrid.innerHTML = `<p style="text-align:center;color:#666;">é»æ“Šã€ŒğŸ’¾ å„²å­˜ã€æŒ‰éˆ•å„²å­˜ç•¶å‰è¼¸å…¥æ¡†å…§å®¹ç‚ºè‡ªè¨‚ç¯„æœ¬</p>`;
                        return;
                    }

                    // å…§å»ºç¯„æœ¬æ˜¯é™£åˆ— [string]ï¼Œè‡ªè¨‚ç¯„æœ¬æ˜¯ç‰©ä»¶ {name: string}
                    const templateList = isCustom ? Object.keys(items).map(k => ({ name: k, content: items[k] })) : items.map(t => ({ name: t, content: t }));

                    templateList.forEach(t => {
                        const div = document.createElement('div');
                        div.className = `template-item ${isCustom ? 'custom' : ''}`;
                        div.innerHTML = `<span class="template-item-content">${t.name}</span>`;
                        
                        // é»æ“Šäº‹ä»¶ï¼šæ–°å¢é …ç›®
                        div.onclick = (e) => {
                             // ç¢ºä¿é»æ“Šçš„ä¸æ˜¯åˆªé™¤æŒ‰éˆ•
                            if (!e.target.classList.contains('delete-template-btn')) {
                                add(t.content);
                                hide();
                            }
                        };
                        
                        // è‡ªè¨‚ç¯„æœ¬åŠ å…¥åˆªé™¤æŒ‰éˆ•
                        if (isCustom) {
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'delete-template-btn';
                            deleteBtn.textContent = 'Ã—';
                            deleteBtn.title = 'åˆªé™¤æ­¤ç¯„æœ¬';
                            deleteBtn.onclick = (e) => {
                                e.stopPropagation(); // é˜²æ­¢è§¸ç™¼çˆ¶å…ƒç´ çš„é»æ“Šäº‹ä»¶
                                if (confirm(`ç¢ºå®šè¦åˆªé™¤è‡ªè¨‚ç¯„æœ¬ã€Œ${t.name}ã€å—ï¼Ÿ`)) {
                                    delete customTemplates[t.name];
                                    save();
                                    renderTabs(); // é‡æ–°æ¸²æŸ“ Tab å’Œ Grid
                                }
                            };
                            div.appendChild(deleteBtn);
                        }
                        
                        templatesGrid.appendChild(div);
                    });
                };
                
                // æ¸²æŸ“é¡åˆ¥ Tabs
                const renderTabs = () => {
                    categoryTabs.innerHTML = '';
                    const allTemplates = getAllTemplates();
                    const categories = Object.keys(allTemplates);

                    // ç¢ºä¿ç•¶å‰é¡åˆ¥ä»ç„¶å­˜åœ¨ï¼Œå¦å‰‡åˆ‡æ›åˆ°ç¬¬ä¸€å€‹
                    if (!categories.includes(currentCategory)) {
                        currentCategory = categories[0];
                    }

                    categories.forEach(cat => {
                        const tab = document.createElement('button');
                        tab.className = 'tab-btn'; tab.dataset.category = cat; tab.textContent = cat;
                        if (cat === currentCategory) { tab.classList.add('active'); }
                        
                        tab.onclick = () => {
                            currentCategory = cat;
                            renderTabs(); // é»æ“Š Tab æ™‚é‡æ–°æ¸²æŸ“æ‰€æœ‰ Tab (æ›´æ–° active ç‹€æ…‹)
                        };
                        categoryTabs.appendChild(tab);
                    });
                    
                    // æ¸²æŸ“å°æ‡‰ Grid å…§å®¹
                    renderGrid(currentCategory, allTemplates[currentCategory]);
                };
                
                // å„²å­˜è‡ªè¨‚ç¯„æœ¬
                saveCustomBtn.onclick = () => {
                    const templateName = customInput.value.trim();
                    const templateContent = input.value.trim();
                    
                    if (!templateName || !templateContent) {
                        alert('è«‹è¼¸å…¥ç¯„æœ¬åç¨±ä¸¦ç¢ºä¿ã€Œæ–°å¢äº‹é …ã€æ¬„ä½æœ‰å…§å®¹ï¼');
                        return;
                    }
                    if (customTemplates[templateName]) {
                        if (!confirm(`ç¯„æœ¬ã€Œ${templateName}ã€å·²å­˜åœ¨ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ`)) {
                            return;
                        }
                    }
                    
                    customTemplates[templateName] = templateContent;
                    save();
                    alert(`ç¯„æœ¬ã€Œ${templateName}ã€å·²å„²å­˜ï¼`);
                    customInput.value = '';
                    currentCategory = "è‡ªè¨‚ç¯„æœ¬"; // åˆ‡æ›åˆ°è‡ªè¨‚ç¯„æœ¬ Tab
                    renderTabs(); // é‡æ–°æ¸²æŸ“ Tabs å’Œ Grid
                };


                showTemplateBtn.addEventListener('click', () => {
                    renderTabs();
                    show();
                });
                modal.addEventListener('click', e => { if (e.target === modal) hide(); });
                document.addEventListener('keydown', e => { if (e.key === 'Escape') hide(); });
                
                // é¦–æ¬¡è¼‰å…¥æ™‚æ¸²æŸ“ä¸€æ¬¡ Tab
                renderTabs();
            };
            initTemplateModal();


            /* --------- å±•ç¤ºæ¨¡å¼åˆ‡æ›ï¼ˆä¿ç•™åŸå§‹ç¢¼ï¼‰ --------- */
            const enterPresentation = async () => {
                isPresentation = true;
                document.body.classList.add('presentation-mode');
                presentationBtn.textContent = 'è¿”å›ç·¨è¼¯';
                try { await document.documentElement.requestFullscreen?.(); } catch (_) { }
            };
            const exitPresentation = async () => {
                isPresentation = false;
                document.body.classList.remove('presentation-mode');
                presentationBtn.textContent = 'å…¨è¢å¹•å±•ç¤º';
                if (document.fullscreenElement) { try { await document.exitFullscreen?.(); } catch (_) { } }
            };
            presentationBtn.addEventListener('click', () => {
                if (!isPresentation) enterPresentation(); else exitPresentation();
            });
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement && isPresentation) {
                    exitPresentation();
                }
            });
        });
    </script>
</body>
</html>
