<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>智慧聯絡簿 v21.0</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
:root{
  --primary:#2b7de9;
  --bg:#fff;
  --text:#000;
  --font-size:2em;
}
*{box-sizing:border-box;font-family:'Microsoft JhengHei','Noto Sans TC',sans-serif;}
body{
  margin:0;background:var(--bg);color:var(--text);
  display:flex;justify-content:center;align-items:center;
  padding:30px;
}
.container{max-width:1280px;width:100%}
.card{border:1px solid #ccc;border-radius:20px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,.1);}
.card-header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;margin-bottom:20px;}
#date-selector{font-size:2em;border:none;background:none;}
#weekno-input{padding:6px 10px;border:1px solid #ccc;border-radius:8px;}
.homework-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px;}
.homework-item{display:flex;gap:10px;padding:8px;border-radius:10px;}
.item-content{flex:1;outline:none;white-space:pre-wrap;font-size:var(--font-size);}
.footer-buttons{display:flex;flex-wrap:wrap;gap:10px;margin-top:15px;}
button{padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:700;}
.btn-primary{background:var(--primary);color:#fff;}
.btn-secondary{background:#eee;}
.presentation-mode #homework-input-area{display:none;}
</style>
</head>
<body>
<div class="container">
  <h1 style="text-align:center;font-size:2.5em;">智慧聯絡簿</h1>
  <div class="card" id="main-card">
    <div class="card-header">
      <button id="prev-day" class="btn-secondary">◀</button>
      <input type="date" id="date-selector">
      <button id="next-day" class="btn-secondary">▶</button>
      <span id="week-display"></span>
      <label>週次 <input type="text" id="weekno-input" placeholder="第 8 週"></label>
    </div>
    <ul id="homework-list" class="homework-list"></ul>
    <div id="homework-input-area" style="display:flex;gap:8px;margin-top:10px;">
      <input type="text" id="new-homework-input" placeholder="新增事項..." style="flex:1;padding:8px;font-size:1.1em;">
      <button id="add-item" class="btn-primary">➕</button>
    </div>
  </div>

  <div class="footer-buttons">
    <label>字級 <input type="range" id="font-slider" min="1" max="3" step="0.1" value="2"></label>
    <button id="copy-prev" class="btn-secondary">複製前日</button>
    <button id="copy-text" class="btn-secondary">複製文字</button>
    <button id="export-png" class="btn-primary">匯出圖片</button>
    <button id="toggle-full" class="btn-secondary">全螢幕展示</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{
  const $=s=>document.querySelector(s),$$=s=>Array.from(document.querySelectorAll(s));
  const dateInput=$("#date-selector"),weekDisp=$("#week-display"),list=$("#homework-list");
  const addBtn=$("#add-item"),textInput=$("#new-homework-input"),weekno=$("#weekno-input");
  const fontSlider=$("#font-slider"),toggleFull=$("#toggle-full");
  const prevBtn=$("#prev-day"),nextBtn=$("#next-day");
  const copyPrev=$("#copy-prev"),copyText=$("#copy-text"),exportBtn=$("#export-png");
  let allData=JSON.parse(localStorage.getItem("contactbook_v21")||"{}"),isFull=false;

  const pad=n=>String(n).padStart(2,"0");
  const today=new Date();let curDate=`${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
  const setWeek=()=>{const d=new Date(curDate);weekDisp.textContent="星期"+"日一二三四五六"[d.getDay()];};
  const render=()=>{
    const items=(allData[curDate]?.items)||[];
    list.innerHTML=items.map((t,i)=>`<li class='homework-item'><span>${i+1}.</span><span contenteditable class='item-content'>${t}</span><button class='del btn-secondary'>刪</button></li>`).join("");
    weekno.value=allData[curDate]?.week||"";
    setWeek();
  };
  const save=()=>{
    const items=$$(".item-content").map(e=>e.textContent.trim()).filter(Boolean);
    allData[curDate]={items,week:weekno.value.trim()};
    localStorage.setItem("contactbook_v21",JSON.stringify(allData));
  };
  addBtn.onclick=()=>{if(!textInput.value.trim())return;const rec=allData[curDate]||{items:[],week:""};rec.items.push(textInput.value.trim());allData[curDate]=rec;textInput.value="";save();render();};
  list.onclick=e=>{
    if(e.target.classList.contains("del")){
      const i=$$(".del").indexOf(e.target);
      allData[curDate].items.splice(i,1);save();render();
    }
  };
  list.addEventListener("focusout",e=>{if(e.target.classList.contains("item-content"))save();});
  weekno.oninput=()=>save();
  dateInput.onchange=e=>{save();curDate=e.target.value;render();};
  prevBtn.onclick=()=>{save();const d=new Date(curDate);d.setDate(d.getDate()-1);curDate=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;dateInput.value=curDate;render();};
  nextBtn.onclick=()=>{save();const d=new Date(curDate);d.setDate(d.getDate()+1);curDate=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;dateInput.value=curDate;render();};
  copyText.onclick=async()=>{
    const d=new Date(curDate);const week="日一二三四五六"[d.getDay()];
    const w=weekno.value?"，"+weekno.value:"";
    const text=`${curDate}（星期${week}${w}）\n`+$$(".item-content").map((e,i)=>`${i+1}. ${e.textContent}`).join("\n");
    await navigator.clipboard.writeText(text);alert("已複製文字");
  };
  copyPrev.onclick=()=>{
    const keys=Object.keys(allData).sort();const idx=keys.indexOf(curDate);
    if(idx<=0)return alert("沒有前日資料");
    const prev=allData[keys[idx-1]];if(!prev)return;
    const replace=confirm("覆蓋今天項目？取消則追加");
    const now=allData[curDate]||{items:[],week:""};
    now.items=replace?prev.items.slice():[...now.items,...prev.items];
    allData[curDate]=now;save();render();
  };
  exportBtn.onclick=async()=>{
    const bar=$("#homework-input-area");bar.style.display="none";
    const canvas=await html2canvas($("#main-card"),{backgroundColor:"#fff",scale:2,onclone:doc=>{
      doc.querySelectorAll(".item-content").forEach(e=>e.style.color="#000");
      doc.querySelector("#homework-input-area")?.remove();
    }});
    const a=document.createElement("a");a.download=`聯絡簿_${curDate}.png`;a.href=canvas.toDataURL();a.click();
    bar.style.display="flex";
  };
  fontSlider.oninput=e=>{
    document.documentElement.style.setProperty("--font-size",e.target.value+"em");
  };
  toggleFull.onclick=async()=>{
    if(!isFull){
      document.body.classList.add("presentation-mode");
      isFull=true;toggleFull.textContent="返回編輯";
      await document.documentElement.requestFullscreen?.();
    }else{
      document.body.classList.remove("presentation-mode");
      isFull=false;toggleFull.textContent="全螢幕展示";
      if(document.fullscreenElement)await document.exitFullscreen?.();
    }
  };
  document.addEventListener("fullscreenchange",()=>{if(!document.fullscreenElement&&isFull){isFull=false;toggleFull.textContent="全螢幕展示";}});
  dateInput.value=curDate;render();
});
</script>
</body>
</html>
