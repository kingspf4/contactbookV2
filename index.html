<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>智慧聯絡簿 v21.1</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
:root{
  --primary:#2b7de9;
  --bg:#ffffff;
  --text:#000000;
  --item-font-size:2.1em; /* 可由滑桿調整 */
  --radius:18px;
}
*{box-sizing:border-box;font-family:'Microsoft JhengHei','Noto Sans TC',sans-serif;}
html,body{height:100%;}
body{
  margin:0;background:var(--bg);color:var(--text);
  display:flex;justify-content:center;align-items:flex-start;
  padding:28px;
}
.container{max-width:1440px;width:100%}
h1{margin:0 0 18px 0;text-align:center;font-size:2.7em;}
.card{
  border:1px solid #e5e5e5;border-radius:var(--radius);
  padding:26px;box-shadow:0 10px 28px rgba(0,0,0,.06);
}
.card-header{
  display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;margin-bottom:16px;
}
.nav-btn{padding:8px 12px;border:none;border-radius:10px;background:#eee;cursor:pointer;font-weight:700;}
#date-selector{font-size:1.8em;border:none;background:none;padding:4px 6px;}
.inline{display:flex;gap:8px;align-items:center}
#week-display{font-weight:700}
#weekno-input{padding:6px 10px;border:1px solid #ccc;border-radius:10px;min-width:110px}

.homework-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:4px}
.homework-item{
  display:flex;gap:8px;align-items:flex-start;
  padding:8px 10px;border-radius:12px;
}
.item-index{min-width:2ch;opacity:.7;padding-top:6px}
.item-content{
  flex:1;outline:none;white-space:pre-wrap;
  font-size:var(--item-font-size); line-height:1.2;
}
.del{padding:6px 10px;border:none;border-radius:10px;background:#eee;cursor:pointer;margin-top:4px}

#homework-input-area{display:flex;gap:10px;margin-top:12px}
#new-homework-input{flex:1;padding:10px 12px;font-size:1.1em;border:1px solid #ccc;border-radius:10px}
.btn{padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:700}
.btn-primary{background:var(--primary);color:#fff}
.btn-secondary{background:#eee}
.footer-buttons{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px;align-items:center}
.range-wrap{display:flex;gap:8px;align-items:center;padding:8px 12px;background:#f4f4f4;border-radius:10px}
#font-slider{width:220px}
.presentation-mode #homework-input-area{display:none;} /* 展示時只藏輸入列，保留按鈕列 */

@media (max-width: 520px){
  h1{font-size:2.1em}
  #date-selector{font-size:1.4em}
  .container{max-width:100%}
}
</style>
</head>
<body>
  <div class="container">
    <h1>智慧聯絡簿</h1>
    <div id="main-card" class="card">
      <div class="card-header">
        <button id="prev-day" class="nav-btn" type="button">◀</button>
        <input type="date" id="date-selector" />
        <button id="next-day" class="nav-btn" type="button">▶</button>

        <span id="week-display" aria-live="polite"></span>

        <div class="inline">
          <label for="weekno-input">週次</label>
          <input id="weekno-input" type="text" placeholder="第 8 週" />
        </div>
      </div>

      <ul id="homework-list" class="homework-list" aria-label="聯絡事項清單"></ul>

      <div id="homework-input-area">
        <input id="new-homework-input" type="text" placeholder="新增事項…" />
        <button id="add-item" class="btn btn-primary" type="button">➕ 加入</button>
      </div>
    </div>

    <div class="footer-buttons">
      <div class="range-wrap">
        <label for="font-slider">字級</label>
        <input id="font-slider" type="range" min="1.2" max="3" step="0.1" value="2.1" />
      </div>
      <button id="copy-prev" class="btn btn-secondary" type="button">複製前日</button>
      <button id="copy-text" class="btn btn-secondary" type="button">複製文字</button>
      <button id="export-png" class="btn btn-primary" type="button">匯出圖片</button>
      <button id="toggle-full" class="btn btn-secondary" type="button">全螢幕展示</button>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  const dateInput = $('#date-selector');
  const weekDisp = $('#week-display');
  const weekNo   = $('#weekno-input');
  const list     = $('#homework-list');
  const textInput= $('#new-homework-input');
  const addBtn   = $('#add-item');
  const prevBtn  = $('#prev-day');
  const nextBtn  = $('#next-day');
  const copyPrev = $('#copy-prev');
  const copyText = $('#copy-text');
  const exportBtn= $('#export-png');
  const fontSlider = $('#font-slider');
  const toggleFull = $('#toggle-full');
  const mainCard = $('#main-card');

  let isFull = false;

  // 資料
  const LS_KEY = 'contactbook_v21';
  let allData = {};
  try{ allData = JSON.parse(localStorage.getItem(LS_KEY) || '{}') }catch{ allData = {} }

  const pad = n => String(n).padStart(2,'0');
  const fmt = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const toDate = str => { const [y,m,dd]=str.split('-').map(Number); return new Date(y, m-1, dd); };
  const dayOfWeek = d => '星期' + '日一二三四五六'[d.getDay()];

  const today = new Date();
  let curDate = fmt(today);

  // ---------- Render / Save ----------
  const reindex = () => {
    $$('.item-index').forEach((el,i)=> el.textContent = (i+1)+'.');
  };

  const render = () => {
    const rec = allData[curDate] || { items: [], week: '' };
    list.innerHTML = '';
    if (rec.items.length === 0) {
      const p = document.createElement('p');
      p.textContent = '點擊下方輸入框新增今日聯絡事項';
      p.style.margin = '8px 0 0 0';
      p.style.opacity = '.7';
      list.appendChild(p);
    } else {
      rec.items.forEach((t,i) => {
        const li = document.createElement('li');
        li.className = 'homework-item';
        li.innerHTML = `
          <span class="item-index">${i+1}.</span>
          <span class="item-content" contenteditable="true">${t}</span>
          <button class="del" type="button">刪</button>
        `;
        list.appendChild(li);
      });
    }
    dateInput.value = curDate;
    weekNo.value = rec.week || '';
    weekDisp.textContent = dayOfWeek(toDate(curDate));
  };

  const getCurrentItems = () =>
    $$('.item-content').map(el => el.textContent.replace(/\s+$/,'')).filter(Boolean);

  const save = () => {
    allData[curDate] = { items: getCurrentItems(), week: (weekNo.value || '').trim() };
    localStorage.setItem(LS_KEY, JSON.stringify(allData));
  };

  // 即時儲存（去抖）
  let saveTimer = null;
  const scheduleSave = () => {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(save, 300);
  };

  // ---------- 初始 ----------
  render();

  // ---------- 事件 ----------
  addBtn.addEventListener('click', () => {
    const t = (textInput.value || '').trim();
    if(!t) return;
    const rec = allData[curDate] || { items: [], week: '' };
    rec.items.push(t);
    allData[curDate] = rec;
    textInput.value = '';
    render(); save();
  });

  textInput.addEventListener('keydown', (e) => {
    // Enter 新增；Shift+Enter 允許換行輸入到輸入框本身（若你想也可放行）
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      addBtn.click();
    }
  });

  list.addEventListener('click', (e) => {
    if (e.target.classList.contains('del')) {
      const idx = $$('.del').indexOf(e.target);
      if (idx >= 0) {
        const rec = allData[curDate] || { items: [], week: '' };
        rec.items.splice(idx,1);
        allData[curDate] = rec;
        render(); save();
      }
    }
  });

  // 內容編輯：即時存、保持 Enter 可換行（contenteditable 預設支援）
  list.addEventListener('input', (e) => {
    if (e.target.classList.contains('item-content')) scheduleSave();
  });
  list.addEventListener('blur', (e) => {
    if (e.target.classList.contains('item-content')) save();
  }, true);

  // 切日期（無鍵盤左右快捷）
  const shiftDay = (delta) => {
    const d = toDate(curDate);
    d.setDate(d.getDate() + delta);
    curDate = fmt(d);
    save(); render();
  };
  prevBtn.addEventListener('click', () => shiftDay(-1));
  nextBtn.addEventListener('click', () => shiftDay(1));
  dateInput.addEventListener('change', (e) => { curDate = e.target.value; render(); });

  weekNo.addEventListener('input', scheduleSave);

  // 複製文字（帶週次）
  copyText.addEventListener('click', async () => {
    const d = toDate(curDate);
    const weekTxt = weekNo.value ? `，${weekNo.value}` : '';
    const text = `${curDate}（${dayOfWeek(d)}${weekTxt}）\n` +
      getCurrentItems().map((t,i)=>`${i+1}. ${t}`).join('\n');
    try{
      await navigator.clipboard.writeText(text);
      alert('已複製到剪貼簿');
    }catch{
      prompt('複製失敗，請手動複製：', text);
    }
  });

  // 複製前日（逐日往前找最近有資料的日子，上限 120 天）
  const findPrevWithData = (startStr) => {
    let d = toDate(startStr);
    for (let i=0;i<120;i++){
      d.setDate(d.getDate()-1);
      const k = fmt(d);
      if (allData[k] && Array.isArray(allData[k].items) && allData[k].items.length>0) {
        return k;
      }
    }
    return null;
  };
  copyPrev.addEventListener('click', () => {
    const prev = findPrevWithData(curDate);
    if (!prev) { alert('最近 120 天內找不到前日資料。'); return; }
    const prevRec = allData[prev];
    const replace = confirm(`找到 ${prev} 的 ${prevRec.items.length} 項。\n按「確定」覆蓋今天；按「取消」追加到今天後面。`);
    const curRec = allData[curDate] || { items: [], week: '' };
    curRec.items = replace ? prevRec.items.slice() : curRec.items.concat(prevRec.items);
    allData[curDate] = curRec;
    render(); save();
    alert(replace ? '已覆蓋今日項目。' : '已把前日項目追加到今天。');
  });

  // 匯出 PNG（白底、不透明、字色強制黑；移除輸入列）
  exportBtn.addEventListener('click', async () => {
    const inputBar = $('#homework-input-area');
    const prevDisplay = inputBar.style.display;
    inputBar.style.display = 'none';
    try{
      const canvas = await html2canvas(mainCard, {
        backgroundColor: '#ffffff',
        scale: Math.min(window.devicePixelRatio||1, 2.5),
        useCORS: true,
        logging: false,
        onclone: (doc) => {
          // 強制黑字（標題/索引/內容/週次）
          doc.querySelectorAll('.item-content,.item-index,h1,#week-display,#weekno-input').forEach(el=>{
            el.style.color = '#000';
          });
          // 移除 clone 裡的輸入列
          doc.querySelector('#homework-input-area')?.remove();
        }
      });
      const a = document.createElement('a');
      a.download = `聯絡簿_${curDate}.png`;
      a.href = canvas.toDataURL('image/png');
      a.click();
    }catch(e){
      alert('匯出圖片失敗：' + (e?.message||e));
    }finally{
      inputBar.style.display = prevDisplay;
    }
  });

  // 字級
  const applyFontSize = v => {
    document.documentElement.style.setProperty('--item-font-size', v + 'em');
  };
  fontSlider.addEventListener('input', e => applyFontSize(e.target.value));

  // 全螢幕展示（保留底部工具列；可調字級；按鈕可返回）
  toggleFull.addEventListener('click', async () => {
    if (!isFull) {
      document.body.classList.add('presentation-mode');
      toggleFull.textContent = '返回編輯';
      isFull = true;
      try { await document.documentElement.requestFullscreen?.(); } catch {}
    } else {
      document.body.classList.remove('presentation-mode');
      toggleFull.textContent = '全螢幕展示';
      isFull = false;
      if (document.fullscreenElement) try { await document.exitFullscreen?.(); } catch {}
    }
  });
  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement && isFull) {
      // 使用者按 ESC 離開全螢幕
      document.body.classList.remove('presentation-mode');
      toggleFull.textContent = '全螢幕展示';
      isFull = false;
    }
  });

  // 初始字級
  applyFontSize(fontSlider.value);

  // 列表變動後重新編號（監聽 DOM 變化）
  const mo = new MutationObserver(reindex);
  mo.observe(list, { childList:true, subtree:false });
});
</script>
</body>
</html>
