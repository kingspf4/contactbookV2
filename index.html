<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ™ºæ…§è¯çµ¡ç°¿ v20.7ï¼ˆç™½åº•ï¼‹å­—è‰²ç·¨è¼¯ï¼‹é«˜å°æ¯”åŒ¯åœ–ï¼‰</title>

  <!-- å‚™æ´å­—å‹ï¼ˆè‹¥ç³»çµ±æ²’æœ‰å¾®è»Ÿæ­£é»‘é«”ï¼‰ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">

  <!-- åŒ¯åœ– -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    /* v20.7ï¼šç™½åº•é»‘å­—ã€å­—è‰²ç·¨è¼¯å™¨ã€ä¿ç•™æ‹–æ›³/å‰æ—¥è¤‡è£½/ç›´æ›¸/å­—ç´š/å…¨è¢å¹•/PNG åŒ¯å‡ºï¼ˆå¯å¼·åˆ¶ç´”é»‘ï¼‰ */
    @font-face{
      font-family:'NumericAndLatinFont';
      src: local('Microsoft JhengHei'), local('Inter'), local('Arial');
      unicode-range: U+0020-007F;
    }
    :root{
      --primary-color:#4091ff;
      --page-bg:#ffffff;            /* ç¶²é èƒŒæ™¯ï¼ˆç™½ï¼‰ */
      --card-bg:#ffffff;            /* å¡ç‰‡åº•ï¼ˆç™½ï¼‰ */
      --card-border:rgba(0,0,0,.12);
      --text-color-primary:#111111; /* é è¨­æ·±é»‘ */
      --text-color-secondary:rgba(0,0,0,.6);
      --input-bg:rgba(0,0,0,.04);
      --shadow-color:rgba(0,0,0,.08);
      --control-radius:14px;
      --danger:#ff5c5c;
      --item-font-size:1.6em;
    }

    *{ box-sizing:border-box }
    html,body{ height:100%; margin:0 }
    body{
      font-family:'Microsoft JhengHei','Noto Sans TC',sans-serif;
      color:var(--text-color-primary);
      background:var(--page-bg);
      -webkit-font-smoothing:antialiased;
      padding:24px 24px 110px;
      display:flex; align-items:center; justify-content:center;
    }

    .container{ max-width:1100px; width:100% }
    .main-header{ text-align:center; margin-bottom:22px }
    .main-title{
      font-family:'ZCOOL KuaiLe','Microsoft JhengHei','Noto Sans TC',sans-serif;
      font-size:3rem; line-height:1.1; margin:0;
      color:var(--text-color-primary);
    }

    .card{
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:28px;
      box-shadow:0 30px 90px var(--shadow-color);
      padding:28px;
      display:flex; flex-direction:column;
      min-height:620px; max-height:80vh;
      animation:fadeIn .4s ease;
    }
    @keyframes fadeIn{ from{opacity:.0; transform:translateY(8px)} to{opacity:1; transform:none} }

    .card-header{
      text-align:center; margin-bottom:18px; padding-bottom:18px;
      border-bottom:1px solid var(--card-border);
      flex-shrink:0;
    }
    #date-selector{
      background:none; border:none; font-size:2.2rem; font-weight:800;
      color:var(--text-color-primary); text-align:center; cursor:pointer;
    }
    #date-selector::-webkit-calendar-picker-indicator{ filter:invert(0); cursor:pointer; transform:scale(1.15) }
    #week-display{ font-size:1.1rem; color:var(--text-color-secondary); margin-top:8px }

    /* æ¸…å–® */
    .homework-list{
      list-style:none; padding:0; margin:0;
      display:flex; flex-direction:column; gap:12px;
      flex-grow:1; overflow:auto; padding:6px; margin:0 -6px;
    }
    .homework-item{
      font-family:'NumericAndLatinFont','Microsoft JhengHei','Noto Sans TC',sans-serif;
      font-size:var(--item-font-size);
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:var(--control-radius);
      border:1px dashed transparent; transition:.2s background-color, .2s box-shadow;
    }
    .homework-item:hover,.homework-item:focus-within{ background:var(--input-bg) }
    .homework-item .grab{ cursor:grab; user-select:none; opacity:.7 }
    .homework-item.dragging{ opacity:.6 }
    .homework-item.drag-over{ background:rgba(64,145,255,.06); border-color:rgba(64,145,255,.35) }
    .item-index{ color:var(--text-color-secondary); font-weight:700 }
    .item-content{ flex:1; outline:none }

    /* è¼¸å…¥åˆ— */
    #homework-input-area{
      display:flex; gap:0; background:var(--input-bg);
      border:1px solid rgba(0,0,0,.08);
      border-radius:var(--control-radius);
      transition:box-shadow .25s ease; flex-shrink:0; margin-top:16px;
    }
    #homework-input-area:focus-within{ box-shadow:0 0 0 4px rgba(64,145,255,.25) }
    #new-homework-input{
      flex:1; background:none; border:none; padding:12px 16px; font-size:1.15rem;
      color:var(--text-color-primary);
      font-family:'NumericAndLatinFont','Microsoft JhengHei','Noto Sans TC',sans-serif;
      outline:none;
    }
    .add-btn{ background:var(--primary-color); color:#fff; border-radius:0 var(--control-radius) var(--control-radius) 0 }

    /* å·¥å…·åˆ— */
    .footer{
      margin-top:16px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    }
    .footer .row{ display:flex; gap:10px; flex:1; flex-wrap:wrap }
    button{
      border:none; border-radius:var(--control-radius);
      padding:10px 14px; font-weight:700; cursor:pointer;
      transition:transform .08s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
    }
    .btn-primary{ background:var(--primary-color); color:#fff }
    .btn-secondary{ background:rgba(0,0,0,.06); color:var(--text-color-primary); border:1px solid rgba(0,0,0,.08) }
    .btn-danger{ background:rgba(255,92,92,.12); color:#a40000; border:1px solid rgba(255,92,92,.35) }
    button:active{ transform:scale(.98) }

    /* å­—ç´šã€å­—è‰² */
    .font-tools{
      display:flex; align-items:center; gap:10px;
      background:rgba(0,0,0,.04); padding:8px 12px;
      border-radius:var(--control-radius); border:1px solid rgba(0,0,0,.08);
    }
    .font-tools label{ color:var(--text-color-secondary); font-weight:700 }
    #font-size-slider{ width:160px; -webkit-appearance:none; background:transparent }
    #font-size-slider::-webkit-slider-runnable-track{ height:4px; background:rgba(0,0,0,.25); border-radius:4px }
    #font-size-slider::-webkit-slider-thumb{ -webkit-appearance:none; height:18px; width:18px; background:var(--primary-color); border-radius:50%; margin-top:-7px; cursor:pointer }
    #font-color-input{ width:42px; height:32px; border:none; background:transparent; padding:0; cursor:pointer }

    /* ç›´æ›¸æ¨¡å¼ */
    .vertical-mode{ flex-direction:row-reverse; align-items:flex-start; overflow-x:auto; overflow-y:hidden; gap:18px }
    .vertical-mode .homework-item{ flex-direction:column; min-width:110px; min-height:420px; height:98%; padding:18px 14px }
    .vertical-mode .item-index{ border-bottom:1px solid rgba(0,0,0,.12); padding-bottom:8px; margin-bottom:10px }
    .vertical-mode .item-content{ writing-mode:vertical-rl; text-align:right; max-height:260px; overflow:auto }
    .vertical-mode .horizontal-in-vertical{ writing-mode:horizontal-tb; display:inline-block; text-orientation:mixed }
    .vertical-mode .delete-item-btn{ opacity:1; align-self:center; padding:4px 6px }

    /* ç¯„æœ¬ modal */
    #template-modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.38); align-items:center; justify-content:center; z-index:10; opacity:0; transition:opacity .25s ease }
    #template-modal.visible{ display:flex; opacity:1 }
    .template-card{ background:#fff; color:#111; border-radius:24px; width:min(860px,92vw); padding:26px; box-shadow:0 30px 90px rgba(0,0,0,.25) }
    .category-tabs{ display:flex; flex-wrap:wrap; gap:10px; padding-bottom:14px; border-bottom:1px solid #e6e6e6; margin-bottom:16px }
    .tab-btn{ background:#f3f5f8; color:#111; border:1px solid #eaecef; border-radius:10px; padding:8px 12px; font-weight:700 }
    .tab-btn.active{ background:#e7f0ff; border-color:#c9defe }
    .templates-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px; max-height:45vh; overflow:auto }
    .template-item{ background:#f8fafc; border:1px solid #eaecef; color:#111; text-align:left; padding:12px; border-radius:12px; font-size:1.05rem }
    .template-item:hover{ background:#e7f0ff }

    .delete-item-btn{ opacity:0; background:none; color:#b40000; font-size:1.1em; line-height:1; padding:4px 8px }
    .homework-item:hover .delete-item-btn{ opacity:1 }

    .creator-credit{ display:none !important }

    @media (max-width:520px){
      .main-title{ font-size:2.2rem }
      #date-selector{ font-size:1.6rem }
      .card{ min-height:560px }
      .font-tools{ flex-wrap:wrap }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-header"><h1 class="main-title">æ™ºæ…§è¯çµ¡ç°¿</h1></div>

    <div class="card" id="main-card">
      <!-- æ—¥æœŸå€ï¼šæ–°å¢ä¸Šä¸€æ—¥ / ä¸‹ä¸€æ—¥ -->
      <div class="card-header">
        <div style="display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap">
          <button id="prev-day-btn" class="btn-secondary" title="ä¸Šä¸€æ—¥">â† ä¸Šä¸€æ—¥</button>
          <input type="date" id="date-selector" aria-label="é¸æ“‡æ—¥æœŸ">
          <button id="next-day-btn" class="btn-secondary" title="ä¸‹ä¸€æ—¥">ä¸‹ä¸€æ—¥ â†’</button>
        </div>
        <div id="week-display" aria-live="polite"></div>
      </div>

      <ul class="homework-list" id="homework-list" aria-label="è¯çµ¡äº‹é …æ¸…å–®"></ul>

      <div id="homework-input-area">
        <input type="text" id="new-homework-input" placeholder="æ–°å¢äº‹é …..." aria-label="æ–°å¢äº‹é …">
        <button id="add-item-btn" class="add-btn" aria-label="åŠ å…¥äº‹é …">â•</button>
        <button id="show-template-btn" class="btn-secondary" title="å¾ç¯„æœ¬åŠ å…¥" aria-label="å¾ç¯„æœ¬åŠ å…¥">ğŸª„</button>
      </div>
    </div>

    <!-- å·¥å…·åˆ— -->
    <div class="footer">
      <div class="row">
        <button id="toggle-vertical-btn" class="btn-secondary" aria-pressed="false">åˆ‡æ›ç›´æ›¸</button>

        <div class="font-tools">
          <label for="font-size-slider">å­—ç´š</label>
          <input type="range" id="font-size-slider" min="1" max="2.8" step="0.1" value="1.6" aria-label="å­—ç´šå¤§å°">
          <label for="font-color-input">å­—è‰²</label>
          <input type="color" id="font-color-input" value="#111111" title="é¸æ“‡å­—é«”é¡è‰²">
          <label style="display:flex; align-items:center; gap:6px; user-select:none">
            <input type="checkbox" id="force-black-export" checked>
            åŒ¯åœ–ç”¨ç´”é»‘å­—
          </label>
        </div>

        <button id="toggle-presentation-btn" class="btn-secondary">å…¨è¢å¹•å±•ç¤º</button>
      </div>

      <div class="row">
        <button id="copy-text-btn" class="btn-secondary">è¤‡è£½æ–‡å­—</button>
        <button id="copy-prev-btn" class="btn-secondary">è¤‡è£½å‰æ—¥</button>

        <button id="export-png-btn" class="btn-primary">åŒ¯å‡ºåœ–ç‰‡ï¼ˆPNGï¼‰</button>
        <button id="export-fullpng-btn" class="btn-secondary">åŒ¯å‡ºæ•´é ï¼ˆPNGï¼‰</button>

        <button id="clear-today-btn" class="btn-danger">æ¸…ç©ºä»Šæ—¥</button>
      </div>
    </div>
  </div>

  <!-- ç¯„æœ¬ Modal -->
  <div id="template-modal">
    <div class="template-card">
      <h2 style="margin:0 0 12px 0">é¸æ“‡ä½œæ¥­ç¯„æœ¬</h2>
      <div id="category-tabs" class="category-tabs"></div>
      <div id="templates-grid" class="templates-grid"></div>
    </div>
  </div>

  <!-- åŸè¨»è¨˜ï¼ˆä¸é¡¯ç¤ºï¼‰ -->
  <a href="https://www.facebook.com/FunFun.AI.Teacher/" target="_blank" rel="noopener noreferrer" class="creator-credit">Created by æ–¹æ–¹è€å¸«</a>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelector('.creator-credit')?.remove();

      // å·¥å…·
      const $ = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));

      // DOM æŠ“å–
      const dateSelector = $('#date-selector');
      const prevDayBtn = $('#prev-day-btn');
      const nextDayBtn = $('#next-day-btn');
      const weekDisplay = $('#week-display');
      const homeworkList = $('#homework-list');
      const newHomeworkInput = $('#new-homework-input');
      const addItemBtn = $('#add-item-btn');
      const togglePresentationBtn = $('#toggle-presentation-btn');
      const toggleVerticalBtn = $('#toggle-vertical-btn');
      const fontSizeSlider = $('#font-size-slider');
      const fontColorInput = $('#font-color-input');
      const forceBlackExport = $('#force-black-export');

      const exportPngBtn = $('#export-png-btn');
      const exportFullPngBtn = $('#export-fullpng-btn');
      const copyTextBtn = $('#copy-text-btn');
      const copyPrevBtn = $('#copy-prev-btn');

      // ç‹€æ…‹
      const today = new Date();
      const pad = n => String(n).padStart(2,'0');
      let currentDate = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
      let isPresentationMode = false;
      let isVerticalMode = false;
      let allData = {};

      // ç¯„æœ¬
      const templates = {
        "åœ‹èªæ–‡":["åœ‹ç¿’ L__","åœ‹èªç¿’ä½œ p.__-`__`","ç”²æœ¬ p.__-`__`","ç”Ÿå­—æœ¬ L__","èªè©æœ¬ L__","åœ‹ç·´ ç¬¬__å›","åœˆè© L__ å¯«__é","èƒŒæ›¸ L__","é»˜æ›¸ L__","æ—¥è¨˜","é–±è®€å¿ƒå¾—"],
        "æ•¸å­¸":["æ•¸ç¿’ p.__-`__`","æ•¸ç·´ ç¬¬__å›","æ•¸ä½œ p.__-`__`","è¨ˆç®—ç·´ç¿’æœ¬ p.__","æ•¸å·è¨‚ç°½","æ‡‰ç”¨é¡Œ x__"],
        "è‹±èª":["è‹±ç¿’ U__","è‹±è½","å–®å­— U__ å¯«__é","èƒŒå–®å­— U__","å¥å‹ç·´ç¿’ x__","èª²æ–‡æœ—è®€ U__"],
        "ç¤¾æœƒè‡ªç„¶":["ç¤¾ç¿’ p.__-`__`","è‡ªç¿’ p.__-`__`","ç¤¾å·è¨‚ç°½","è‡ªå·è¨‚ç°½","å­¸ç¿’å–®","å ±å‘Šï¼š__","è§€å¯Ÿç´€éŒ„ï¼š__"],
        "é€šç”¨":["è€ƒå·è¨‚ç°½","è¤‡ç¿’ L__-`__`","é ç¿’ L__","ç™¼å›æ¢","å¸¶__","åšå®¶äº‹","é‹å‹•30åˆ†é˜","è¦ªå­å…±è®€"]
      };

      // å„²å­˜/è¼‰å…¥
      const getCurrentItems = () => $$('.item-content').map(el => el.textContent.trim()).filter(Boolean);
      const saveData = () => { allData[currentDate] = getCurrentItems(); localStorage.setItem('ultraContactBook_v20_final', JSON.stringify(allData)); };
      const loadData = () => {
        try{
          const data = JSON.parse(localStorage.getItem('ultraContactBook_v20_final'));
          if (data && typeof data === 'object') allData = data;
        }catch(e){}
        loadDataForDate(currentDate);
      };
      const loadDataForDate = (date) => { renderHomeworkList(allData[date] || []); };

      // æ—¥æœŸ & é€±
      const updateDate = (dateString) => {
        const d = new Date(dateString + 'T00:00:00');
        const week = ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'][d.getDay()];
        weekDisplay.textContent = week;
        dateSelector.value = dateString;
      };
      const ensureDate = () => { if (!dateSelector.value) dateSelector.value = currentDate; };
      const fmt = (d) => { const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; };
      const stepDate = (delta) => {
        saveData();
        const [y,m,dd] = dateSelector.value.split('-').map(Number);
        const d = new Date(y, m-1, dd);
        d.setDate(d.getDate()+delta);
        currentDate = fmt(d);
        updateDate(currentDate);
        loadDataForDate(currentDate);
      };

      // ç›´æ›¸ä¸­çš„æ©«æ’ç‰‡æ®µ
      const processTextForVertical = (text) => {
        const regex = /([a-zA-Z0-9\s._'`-]+)/g;
        return text.split(regex).map(seg => seg.match(regex) && seg.trim()!=='' ? `<span class="horizontal-in-vertical">${seg}</span>` : `<span>${seg}</span>`).join('');
      };

      // æ¸²æŸ“æ¸…å–®
      const renderHomeworkList = (items) => {
        homeworkList.innerHTML = '';
        if (!items || items.length === 0) {
          homeworkList.innerHTML = `<p style="font-size:1rem; text-align:center; margin:auto; color:var(--text-color-secondary)">é»æ“Šä¸‹æ–¹è¼¸å…¥æ¡†æ–°å¢ä»Šæ—¥è¯çµ¡äº‹é …</p>`;
          return;
        }
        items.forEach((text, idx) => {
          const li = document.createElement('li');
          li.className = 'homework-item';
          li.setAttribute('draggable','true');
          const contentHTML = isVerticalMode ? processTextForVertical(text) : text;
          li.innerHTML = `
            <span class="grab" title="æ‹–æ›³æ’åº">â˜°</span>
            <span class="item-index">${idx+1}.</span>
            <span class="item-content" contenteditable="true">${contentHTML}</span>
            <button class="delete-item-btn" title="åˆªé™¤">Ã—</button>
          `;
          homeworkList.appendChild(li);
        });
      };

      // æ–°å¢
      const addHomework = (text) => {
        const t = (text||'').trim();
        if (!t) return;
        const arr = getCurrentItems();
        arr.push(t);
        renderHomeworkList(arr);
        saveData();
        newHomeworkInput.value = '';
        newHomeworkInput.focus();
      };

      // æ¨¡å¼
      const togglePresentation = () => {
        isPresentationMode = !isPresentationMode;
        document.body.classList.toggle('presentation-mode', isPresentationMode);
        togglePresentationBtn.textContent = isPresentationMode ? 'è¿”å›ç·¨è¼¯' : 'å…¨è¢å¹•å±•ç¤º';
        if (isPresentationMode) document.documentElement.requestFullscreen?.();
        else if (document.fullscreenElement) document.exitFullscreen?.();
      };
      const toggleVertical = () => {
        isVerticalMode = !isVerticalMode;
        homeworkList.classList.toggle('vertical-mode', isVerticalMode);
        toggleVerticalBtn.setAttribute('aria-pressed', String(isVerticalMode));
        toggleVerticalBtn.textContent = isVerticalMode ? 'åˆ‡æ›æ©«æ›¸' : 'åˆ‡æ›ç›´æ›¸';
        renderHomeworkList(getCurrentItems());
      };

      // åå¥½ï¼ˆå­—ç´šã€å­—è‰²ï¼‰
      const applyFontSize = (size) => { document.documentElement.style.setProperty('--item-font-size', `${size}em`); };
      const applyFontColor = (hex) => {
        document.documentElement.style.setProperty('--text-color-primary', hex);
        // ä¾ä¸»è‰²è‡ªå‹•èª¿æ•´æ¬¡è¦è‰²ï¼ˆç°¡å–®æ¯”ä¾‹ï¼‰
        const secondary = hex === '#000000' ? 'rgba(0,0,0,.6)' : 'rgba(0,0,0,.6)';
        document.documentElement.style.setProperty('--text-color-secondary', secondary);
      };
      const loadPreferences = () => {
        const s = localStorage.getItem('fontSizePreference_v20'); if (s){ fontSizeSlider.value = s; applyFontSize(s); }
        const c = localStorage.getItem('fontColorPreference_v20'); if (c){ fontColorInput.value = c; applyFontColor(c); }
      };

      // ç¯„æœ¬ Modal
      const initTemplateModal = () => {
        const modal = $('#template-modal');
        const showTemplateBtn = $('#show-template-btn');
        const categoryTabs = $('#category-tabs');
        const templatesGrid = $('#templates-grid');
        let isInitialized = false;
        const show = () => modal.classList.add('visible');
        const hide = () => modal.classList.remove('visible');

        const renderCategory = (cat) => {
          categoryTabs.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          categoryTabs.querySelector(`.tab-btn[data-category="${cat}"]`)?.classList.add('active');
          templatesGrid.innerHTML = '';
          (templates[cat]||[]).forEach(t => {
            const btn = document.createElement('button');
            btn.className = 'template-item';
            btn.textContent = t;
            btn.onclick = () => { addHomework(t); hide(); };
            templatesGrid.appendChild(btn);
          });
        };

        showTemplateBtn.addEventListener('click', () => {
          if (!isInitialized) {
            Object.keys(templates).forEach(cat => {
              const tab = document.createElement('button');
              tab.className = 'tab-btn'; tab.textContent = cat; tab.dataset.category = cat;
              tab.onclick = () => renderCategory(cat);
              categoryTabs.appendChild(tab);
            });
            renderCategory(Object.keys(templates)[0]);
            isInitialized = true;
          }
          show();
        });
        modal.addEventListener('click', e => { if (e.target === modal) hide(); });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') hide(); });
      };

      // äº‹ä»¶ï¼šåˆªé™¤/ç·¨è¼¯/è²¼ä¸Šç´”æ–‡å­—
      homeworkList.addEventListener('click', e => {
        if (e.target.classList.contains('delete-item-btn')) {
          const item = e.target.closest('.homework-item');
          const idx = $$('.homework-item').indexOf(item);
          const arr = getCurrentItems();
          arr.splice(idx,1);
          renderHomeworkList(arr);
          saveData();
        }
      });
      homeworkList.addEventListener('focusout', e => { if (e.target.classList.contains('item-content')) saveData(); });
      homeworkList.addEventListener('keydown', e => {
        if (e.target.classList.contains('item-content') && e.key === 'Enter' && !e.isComposing) { e.preventDefault(); e.target.blur(); }
      });
      homeworkList.addEventListener('paste', e => {
        if (e.target.classList.contains('item-content')) {
          e.preventDefault();
          const text = (e.clipboardData || window.clipboardData).getData('text');
          document.execCommand('insertText', false, text);
        }
      });

      // æ‹–æ›³æ’åº
      let dragIndex = null;
      homeworkList.addEventListener('dragstart', e => {
        const li = e.target.closest('.homework-item'); if (!li) return;
        li.classList.add('dragging');
        dragIndex = $$('.homework-item').indexOf(li);
        e.dataTransfer.effectAllowed = 'move';
      });
      homeworkList.addEventListener('dragend', e => {
        e.target.closest('.homework-item')?.classList.remove('dragging');
        $$('.homework-item').forEach(li=>li.classList.remove('drag-over'));
        dragIndex = null;
      });
      homeworkList.addEventListener('dragover', e => {
        e.preventDefault();
        const li = e.target.closest('.homework-item'); if (!li) return;
        $$('.homework-item').forEach(x=>x.classList.remove('drag-over'));
        li.classList.add('drag-over');
        e.dataTransfer.dropEffect = 'move';
      });
      homeworkList.addEventListener('drop', e => {
        e.preventDefault();
        const li = e.target.closest('.homework-item');
        $$('.homework-item').forEach(x=>x.classList.remove('drag-over'));
        if (li == null || dragIndex == null) return;
        const dropIndex = $$('.homework-item').indexOf(li);
        if (dropIndex === -1 || dragIndex === dropIndex) return;
        const arr = getCurrentItems();
        const [moved] = arr.splice(dragIndex,1);
        arr.splice(dropIndex,0,moved);
        renderHomeworkList(arr);
        saveData();
      });

      // åˆå§‹åŒ–
      updateDate(currentDate);
      loadData();
      loadPreferences();
      initTemplateModal();
      requestAnimationFrame(() => ensureDate());

      // æ–°å¢
      addItemBtn.addEventListener('click', () => addHomework(newHomeworkInput.value));
      newHomeworkInput.addEventListener('keydown', e => { if (e.key==='Enter' && !e.isComposing) { e.preventDefault(); addHomework(newHomeworkInput.value); } });

      // æ—¥æœŸåˆ‡æ›
      dateSelector.addEventListener('change', e => { saveData(); currentDate = e.target.value; updateDate(currentDate); loadDataForDate(currentDate); });
      prevDayBtn.addEventListener('click', () => stepDate(-1));
      nextDayBtn.addEventListener('click', () => stepDate(+1));

      // æ¨¡å¼ & å­—ç´š/å­—è‰²
      togglePresentationBtn.addEventListener('click', togglePresentation);
      document.addEventListener('fullscreenchange', () => { if (!document.fullscreenElement && isPresentationMode) togglePresentation(); });
      toggleVerticalBtn.addEventListener('click', toggleVertical);
      fontSizeSlider.addEventListener('input', e => {
        const v = e.target.value;
        applyFontSize(v);
        localStorage.setItem('fontSizePreference_v20', v);
      });
      fontColorInput.addEventListener('input', e => {
        const hex = e.target.value;
        applyFontColor(hex);
        localStorage.setItem('fontColorPreference_v20', hex);
      });

      // æ–‡å­—è¤‡è£½
      copyTextBtn.addEventListener('click', async () => {
        ensureDate();
        const d = new Date(dateSelector.value + 'T00:00:00');
        const week = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
        const header = `${dateSelector.value.replace(/-/g,'/')}ï¼ˆæ˜ŸæœŸ${week}ï¼‰`;
        const items = getCurrentItems().map((t,i)=>`${i+1}. ${t}`).join('\n');
        const text = `${header}\n${items}`;
        try{ await navigator.clipboard.writeText(text); alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿'); } catch{ prompt('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š', text); }
      });

      // å‰æ—¥è¤‡è£½ï¼ˆå°‹æ‰¾æœ€è¿‘ 60 å¤©å…§æœ‰è³‡æ–™è€…ï¼‰
      const getPrevDateStr = (dateStr) => { const [y,m,dd]=dateStr.split('-').map(Number); const d=new Date(y,m-1,dd); d.setDate(d.getDate()-1); return fmt(d); };
      const findPreviousDateWithData = (dateStr, limit=60) => { let d=dateStr; for(let i=0;i<limit;i++){ d=getPrevDateStr(d); const arr=allData?.[d]; if(Array.isArray(arr)&&arr.length>0) return d; } return null; };
      copyPrevBtn.addEventListener('click', () => {
        ensureDate();
        const prev = findPreviousDateWithData(currentDate, 60);
        if (!prev) return alert('æ‰¾ä¸åˆ°å‰æ—¥çš„è¯çµ¡äº‹é …ï¼ˆæœ€è¿‘ 60 å¤©éƒ½æ²’æœ‰è³‡æ–™ï¼‰ã€‚');
        const prevItems = (allData[prev] || []).slice();
        if (prevItems.length === 0) return alert(`${prev} æ²’æœ‰é …ç›®å¯è¤‡è£½ã€‚`);
        const replace = confirm(`æ‰¾åˆ° ${prev} çš„ ${prevItems.length} é …ã€‚\n\næŒ‰ã€Œç¢ºå®šã€â†’ è¦†è“‹ä»Šå¤©\næŒ‰ã€Œå–æ¶ˆã€â†’ è¿½åŠ åˆ°ä»Šå¤©å¾Œé¢`);
        const result = replace ? prevItems : [...getCurrentItems(), ...prevItems];
        renderHomeworkList(result);
        saveData();
        alert(replace ? 'å·²è¦†è“‹ä»Šæ—¥é …ç›®ã€‚' : 'å·²æŠŠå‰æ—¥é …ç›®è¿½åŠ åˆ°ä»Šå¤©ã€‚');
      });

      // åŒ¯å‡ºï¼ˆå¡ç‰‡ PNGï¼‰
      const exportCardAsPng = async () => {
        ensureDate();
        if (typeof html2canvas !== 'function') return alert('åŒ¯å‡ºæ¨¡çµ„æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');

        const d = new Date(dateSelector.value + 'T00:00:00');
        const ts = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

        const bar = $('#homework-input-area');
        const prevDisplay = bar?.style.display;
        if (bar) bar.style.display = 'none';

        try{
          const node = $('#main-card');
          const canvas = await html2canvas(node,{
            scale: Math.min(window.devicePixelRatio||1,3),
            useCORS: true,
            backgroundColor: '#ffffff', // å¯¦è‰²ç™½åº•
            logging: false,
            onclone:(doc)=>{
              doc.body.style.background = '#ffffff';

              // ä¾å‹¾é¸æ±ºå®šå­—è‰²ï¼šå¼·åˆ¶ç´”é»‘ æˆ– ä½¿ç”¨ç•¶å‰é¸è‰²
              const chosen = fontColorInput.value || '#111111';
              const forceBlack = forceBlackExport.checked;
              const exportTextColor = forceBlack ? '#000000' : chosen;

              const forceCss = `
                *{ color:${exportTextColor} !important; text-shadow:none !important }
                #main-card, .template-card{ background:#ffffff !important }
              `;
              const st = doc.createElement('style'); st.textContent = forceCss; doc.head.appendChild(st);

              const c=doc.querySelector('#main-card');
              if(c){
                c.style.maxHeight='none';
                c.style.background = '#ffffff';
                const list=c.querySelector('#homework-list');
                if(list) list.style.overflow='visible';
              }
              doc.querySelector('#homework-input-area')?.remove();
            }
          });

          const a=document.createElement('a');
          a.download=`è¯çµ¡ç°¿_${ts}.png`;
          a.href=canvas.toDataURL('image/png');
          document.body.appendChild(a); a.click(); a.remove();
        }catch(e){ alert('åŒ¯å‡ºåœ–ç‰‡å¤±æ•—ï¼š'+(e?.message||e)); }
        finally{
          if (bar) bar.style.display = prevDisplay ?? '';
        }
      };

      // åŒ¯å‡ºï¼ˆæ•´é  PNGï¼‰
      const exportFullAsPng = async () => {
        ensureDate();
        if (typeof html2canvas !== 'function') return alert('åŒ¯å‡ºæ¨¡çµ„æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');

        const d = new Date(dateSelector.value + 'T00:00:00');
        const ts = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

        const bar = $('#homework-input-area');
        const prevDisplay = bar?.style.display;
        if (bar) bar.style.display = 'none';

        try{
          const node = $('.container');
          const canvas = await html2canvas(node,{
            scale: Math.min(window.devicePixelRatio||1,2.6),
            useCORS: true,
            backgroundColor: '#ffffff',
            logging: false,
            onclone:(doc)=>{
              doc.body.style.background='#ffffff';

              const chosen = fontColorInput.value || '#111111';
              const forceBlack = forceBlackExport.checked;
              const exportTextColor = forceBlack ? '#000000' : chosen;

              const forceCss = `
                *{ color:${exportTextColor} !important; text-shadow:none !important }
                #main-card, .template-card{ background:#ffffff !important }
              `;
              const st = doc.createElement('style'); st.textContent = forceCss; doc.head.appendChild(st);

              const c=doc.querySelector('#main-card');
              if(c){
                c.style.maxHeight='none';
                c.style.background = '#ffffff';
                const list=c.querySelector('#homework-list');
                if(list) list.style.overflow='visible';
              }
              doc.querySelector('#homework-input-area')?.remove();
              doc.getElementById('template-modal')?.classList.remove('visible');
            }
          });

          const a=document.createElement('a');
          a.download=`è¯çµ¡ç°¿æ•´é _${ts}.png`;
          a.href=canvas.toDataURL('image/png');
          document.body.appendChild(a); a.click(); a.remove();
        }catch(e){ alert('åŒ¯å‡ºæ•´é åœ–ç‰‡å¤±æ•—ï¼š'+(e?.message||e)); }
        finally{
          if (bar) bar.style.display = prevDisplay ?? '';
        }
      };

      exportPngBtn.addEventListener('click', exportCardAsPng);
      exportFullPngBtn.addEventListener('click', exportFullAsPng);

      // æ¸…ç©ºä»Šæ—¥
      $('#clear-today-btn').addEventListener('click', () => {
        ensureDate();
        if (!confirm(`ç¢ºå®šè¦æ¸…ç©º ${dateSelector.value} çš„äº‹é …å—ï¼Ÿ`)) return;
        allData[currentDate] = [];
        renderHomeworkList([]);
        saveData();
      });
    });
  </script>
</body>
</html>
