<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ™ºæ…§è¯çµ¡ç°¿ v20.2ï¼ˆç©©å®šä¿®æ­£ç‰ˆï¼‰</title>
  <!-- å­—å‹æ”¹ç”¨ <link>ï¼Œé¿å… @import å½±éŸ¿åŒ¯å‡º -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
  <!-- åŒ¯å‡ºåœ–ç‰‡ç”¨ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    /* v20.2: ä¿®æ­£ keypress/IMEã€æ—¥æœŸåˆ‡æ›è‡ªå‹•å„²å­˜ã€åŒ¯å‡ºé˜²å‘†ã€å‹•ç•«å®šç¾©ã€ä¸€æ¬¡æ€§äº‹ä»¶ç¶å®š */
    @font-face { font-family: 'NumericAndLatinFont'; src: local('Inter'), local('Noto Sans TC'), local('Arial'); unicode-range: U+0020-007F; }
    :root { --primary-color:#87CEEB; --card-bg:rgba(80,80,80,.65); --card-border:rgba(255,255,255,.2); --text-color-primary:rgba(245,245,220,.95); --text-color-secondary:rgba(245,245,220,.6); --input-bg:rgba(0,0,0,.35); --shadow-color:rgba(0,0,0,.4); --control-border-radius:12px; --delete-color:#FF6347; --item-font-size:1.5em; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{font-family:'Noto Sans TC',sans-serif;color:var(--text-color-primary);-webkit-font-smoothing:antialiased;background-image:url('https://www.transparenttextures.com/patterns/green-dust-and-scratches.png');background-color:#3D4A45;background-repeat:repeat;padding:20px 20px 70px;display:flex;align-items:center;justify-content:center}
    .container{max-width:800px;width:100%}
    .main-header{text-align:center;margin-bottom:25px}
    .main-title{font-family:'ZCOOL KuaiLe',sans-serif;font-size:3em;font-weight:900;color:#fff;text-shadow:0 3px 15px rgba(0,0,0,.5)}
    .card{background:var(--card-bg);backdrop-filter:blur(25px) saturate(150%);-webkit-backdrop-filter:blur(25px) saturate(150%);border-radius:24px;border:1px solid var(--card-border);box-shadow:0 15px 50px 0 var(--shadow-color);padding:30px;animation:fadeIn .8s cubic-bezier(.2,.8,.2,1);display:flex;flex-direction:column;min-height:600px;max-height:90vh}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}
    @keyframes itemFadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    .card-header{text-align:center;margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--card-border);flex-shrink:0}
    #date-selector{background:none;border:none;color:var(--text-color-primary);font-size:2.2em;font-weight:700;text-align:center;cursor:pointer}
    #date-selector::-webkit-calendar-picker-indicator{filter:invert(1);cursor:pointer;transform:scale(1.2)}
    #week-display{font-size:1.2em;font-weight:500;color:var(--text-color-secondary);margin-top:8px}
    .homework-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:15px;flex-grow:1;overflow:auto;padding:5px;margin:0 -5px}
    .homework-item{font-family:'NumericAndLatinFont','ZCOOL KuaiLe','Noto Sans TC',sans-serif;font-size:var(--item-font-size);display:flex;align-items:center;gap:15px;padding:12px;border-radius:var(--control-border-radius);transition:background-color .2s ease;animation:itemFadeIn .25s ease forwards;position:relative}
    .homework-item .item-content{flex-grow:1;outline:none}
    .homework-item:hover,.homework-item:focus-within{background-color:rgba(0,0,0,.2)}
    .item-index{font-family:'NumericAndLatinFont','Inter',sans-serif;font-weight:600;color:var(--text-color-secondary)}
    #homework-input-area{display:flex;gap:0;background-color:var(--input-bg);border-radius:var(--control-border-radius);border:1px solid rgba(255,255,255,.1);transition:box-shadow .3s ease;flex-shrink:0;margin-top:20px}
    #homework-input-area:focus-within{box-shadow:0 0 0 4px var(--primary-color)}
    #new-homework-input{flex-grow:1;background:none;border:none;padding:14px 18px;font-size:1.2em;color:var(--text-color-primary);font-family:'NumericAndLatinFont','ZCOOL KuaiLe',sans-serif}
    #new-homework-input:focus{outline:none}
    button{border:none;font-weight:600;cursor:pointer;transition:all .3s ease;border-radius:var(--control-border-radius)!important;padding:14px 20px}
    #show-template-btn{background:none;color:var(--text-color-secondary);font-size:1.5em;padding:0 15px;flex-shrink:0}
    #show-template-btn:hover{color:var(--text-color-primary)}
    .btn-primary{background:var(--primary-color);color:#1c1c1e}
    .btn-secondary{background:rgba(255,255,255,.15);color:var(--text-color-primary)}
    .delete-item-btn{opacity:0;font-family:'Inter',sans-serif;background:none;color:rgba(255,255,255,.4);font-size:1em;line-height:1;transition:all .2s}
    .homework-item:hover .delete-item-btn{opacity:1}
    .delete-item-btn:hover{color:var(--delete-color);transform:scale(1.1)}
    .footer-buttons{display:flex;flex-wrap:wrap;justify-content:center;gap:15px;margin-top:30px;align-items:center}
    .footer-buttons button{font-size:1em;padding:12px 20px;flex-grow:1;flex-basis:150px;text-align:center}
    .font-slider-container{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.15);padding:8px 15px;border-radius:var(--control-border-radius);flex-grow:1;flex-basis:150px}
    .font-slider-container label{font-family:'ZCOOL KuaiLe',sans-serif;font-size:1.2em;font-weight:600}
    #font-size-slider{width:100%;-webkit-appearance:none;background:transparent}
    #font-size-slider:focus{outline:none}
    #font-size-slider::-webkit-slider-runnable-track{height:4px;background:rgba(0,0,0,.5);border-radius:5px}
    #font-size-slider::-webkit-slider-thumb{-webkit-appearance:none;height:18px;width:18px;background:var(--primary-color);border-radius:50%;margin-top:-7px;cursor:pointer}
    /* éš±è—ä½œè€…æ¨™è¨˜ï¼ˆé é¢èˆ‡åŒ¯å‡ºæª”éƒ½ä¸é¡¯ç¤ºï¼‰ */
    .creator-credit{display:none!important}
    /* ç›´æ›¸æ¨¡å¼ */
    .vertical-mode{flex-direction:row-reverse;align-items:flex-start;overflow-x:auto;overflow-y:hidden;gap:20px}
    .vertical-mode .homework-item{display:flex;flex-direction:column;justify-content:space-between;align-items:stretch;width:auto;min-width:100px;height:98%;min-height:400px;flex-shrink:0;padding:20px 15px}
    .vertical-mode .item-main-content{display:flex;flex-direction:column;align-items:center;width:100%;overflow:hidden}
    .vertical-mode .item-index{border-bottom:1px solid var(--text-color-secondary);padding-bottom:10px;margin-bottom:15px}
    .vertical-mode .item-content{writing-mode:vertical-rl;overflow-y:auto;text-align:right;max-height:250px;width:auto}
    .vertical-mode .horizontal-in-vertical{writing-mode:horizontal-tb;display:inline-block;text-orientation:mixed}
    .vertical-mode .delete-item-btn{opacity:1;padding:5px;align-self:center}
    .vertical-mode>p{writing-mode:vertical-rl;text-orientation:upright;margin:0 auto;align-self:center}
    /* ç¯„æœ¬ Modal */
    #template-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:10;opacity:0;transition:opacity .3s ease}
    #template-modal.visible{display:flex;opacity:1}
    .template-card{padding:30px;max-width:800px;width:90%;transform:scale(.95);transition:transform .3s cubic-bezier(.18,.89,.32,1.28)}
    #template-modal.visible .template-card{transform:scale(1)}
    .category-tabs{display:flex;flex-wrap:wrap;gap:10px;border-bottom:1px solid var(--card-border);padding-bottom:15px;margin-bottom:20px}
    .tab-btn{background:rgba(0,0,0,.2);color:var(--text-color-secondary);padding:10px 15px;border-radius:10px;font-weight:600}
    .tab-btn.active{background:var(--primary-color);color:#1c1c1e}
    .templates-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;max-height:45vh;overflow-y:auto;padding-right:10px;font-family:'NumericAndLatinFont','ZCOOL KuaiLe',sans-serif}
    .template-item{background:var(--input-bg);color:var(--text-color-primary);text-align:left;padding:15px;border-radius:10px;font-size:1.2em}
    .template-item:hover{background:var(--primary-color);color:#1c1c1e}
  </style>
</head>
<body>
  <div class="container">
    <div class="main-header"><h1 class="main-title">æ™ºæ…§è¯çµ¡ç°¿</h1></div>
    <div class="card" id="main-card">
      <div class="card-header"><input type="date" id="date-selector"><div id="week-display"></div></div>
      <ul class="homework-list" id="homework-list"></ul>
      <div id="homework-input-area"><input type="text" id="new-homework-input" placeholder="æ–°å¢äº‹é …..."><button id="show-template-btn" class="btn-secondary" title="å¾ç¯„æœ¬åŠ å…¥">ğŸª„</button></div>
    </div>
    <div class="footer-buttons">
      <button id="toggle-vertical-btn" class="btn-secondary">åˆ‡æ›ç›´æ›¸</button>
      <div class="font-slider-container">
        <label for="font-size-slider">å­—</label>
        <input type="range" id="font-size-slider" min="1" max="2.5" step="0.1" value="1.5">
      </div>
      <button id="toggle-presentation-btn" class="btn-secondary">å…¨è¢å¹•å±•ç¤º</button>
      <button id="export-html-btn" class="btn-secondary">åŒ¯å‡ºè¯çµ¡ç°¿</button>
      <button id="export-png-btn" class="btn-primary">åŒ¯å‡ºåœ–ç‰‡ï¼ˆPNGï¼‰</button>
      <button id="export-fullpng-btn" class="btn-secondary">åŒ¯å‡ºæ•´é ï¼ˆPNGï¼‰</button>
    </div>
  </div>
  <div id="template-modal"><div class="card template-card"><h2>é¸æ“‡ä½œæ¥­ç¯„æœ¬</h2><div id="category-tabs" class="category-tabs"></div><div id="templates-grid" class="templates-grid"></div></div></div>
  <a href="https://www.facebook.com/FunFun.AI.Teacher/" target="_blank" rel="noopener noreferrer" class="creator-credit">Created by æ–¹æ–¹è€å¸«</a>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ç§»é™¤ä½œè€…æ¨™è¨˜
      document.querySelector('.creator-credit')?.remove();

      // å·¥å…·
      const $ = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));

      // DOM
      const dateSelector = $('#date-selector');
      const weekDisplay = $('#week-display');
      const homeworkList = $('#homework-list');
      const newHomeworkInput = $('#new-homework-input');
      const exportHtmlBtn = $('#export-html-btn');
      const exportPngBtn = $('#export-png-btn');
      const exportFullPngBtn = $('#export-fullpng-btn');
      const togglePresentationBtn = $('#toggle-presentation-btn');
      const toggleVerticalBtn = $('#toggle-vertical-btn');
      const fontSizeSlider = $('#font-size-slider');

      // ç‹€æ…‹
      const today = new Date();
      const pad = n => String(n).padStart(2,'0');
      let currentDate = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`; // æœ¬åœ°æ™‚å€
      let isPresentationMode = false;
      let isVerticalMode = false;
      let allData = {}; // æ”¾å„æ—¥æœŸçš„äº‹é …

      // ç¯„æœ¬
      const templates = {
        "åœ‹èªæ–‡":["åœ‹ç¿’ L__","åœ‹èªç¿’ä½œ p.__-`__`","ç”²æœ¬ p.__-`__`","ç”Ÿå­—æœ¬ L__","èªè©æœ¬ L__","åœ‹ç·´ ç¬¬__å›","åœˆè© L__ å¯«__é","èƒŒæ›¸ L__","é»˜æ›¸ L__","æ—¥è¨˜","é–±è®€å¿ƒå¾—"],
        "æ•¸å­¸":["æ•¸ç¿’ p.__-`__`","æ•¸ç·´ ç¬¬__å›","æ•¸ä½œ p.__-`__`","è¨ˆç®—ç·´ç¿’æœ¬ p.__","æ•¸å·è¨‚ç°½","æ‡‰ç”¨é¡Œ x__"],
        "è‹±èª":["è‹±ç¿’ U__","è‹±è½","å–®å­— U__ å¯«__é","èƒŒå–®å­— U__","å¥å‹ç·´ç¿’ x__","èª²æ–‡æœ—è®€ U__"],
        "ç¤¾æœƒè‡ªç„¶":["ç¤¾ç¿’ p.__-`__`","è‡ªç¿’ p.__-`__`","ç¤¾å·è¨‚ç°½","è‡ªå·è¨‚ç°½","å­¸ç¿’å–®","å ±å‘Šï¼š__","è§€å¯Ÿç´€éŒ„ï¼š__"],
        "é€šç”¨":["è€ƒå·è¨‚ç°½","è¤‡ç¿’ L__-`__`","é ç¿’ L__","ç™¼å›æ¢","å¸¶__","åšå®¶äº‹","é‹å‹•30åˆ†é˜","è¦ªå­å…±è®€"]
      };

      // å„²å­˜èˆ‡è¼‰å…¥
      const getCurrentItems = () => $$('.item-content').map(el => el.textContent.trim()).filter(Boolean);
      const saveData = () => { allData[currentDate] = getCurrentItems(); localStorage.setItem('ultraContactBook_v20_final', JSON.stringify(allData)); };
      const loadData = () => { try { const data = JSON.parse(localStorage.getItem('ultraContactBook_v20_final')); if (data && typeof data === 'object') allData = data; } catch(e){} loadDataForDate(currentDate); };
      const loadDataForDate = (date) => { renderHomeworkList(allData[date] || []); };

      // UI
      const updateDate = (dateString) => {
        const d = new Date(dateString + 'T00:00:00');
        const week = ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'][d.getDay()];
        weekDisplay.textContent = week;
        dateSelector.value = dateString;
      };
      const processTextForVertical = (text) => {
        const regex = /([a-zA-Z0-9\s._'-]+)/g;
        return text.split(regex).map(seg => seg.match(regex) && seg.trim()!=='' ? `<span class="horizontal-in-vertical">${seg}</span>` : `<span>${seg}</span>`).join('');
      };
      const renderHomeworkList = (items) => {
        homeworkList.innerHTML = '';
        if (!items || items.length === 0) {
          homeworkList.innerHTML = `<p style="font-family:'Noto Sans TC',sans-serif;font-size:1rem;text-align:center;margin:auto;">é»æ“Šä¸‹æ–¹è¼¸å…¥æ¡†æ–°å¢ä»Šæ—¥è¯çµ¡äº‹é …</p>`;
          return;
        }
        items.forEach((text, idx) => {
          const li = document.createElement('li');
          li.className = 'homework-item';
          const contentHTML = isVerticalMode ? processTextForVertical(text) : text;
          li.innerHTML = `
            <div class="item-main-content">
              <span class="item-index">${idx+1}.</span>
              <span class="item-content" contenteditable="true">${contentHTML}</span>
            </div>
            <button class="delete-item-btn" title="åˆªé™¤">&times;</button>
          `;
          homeworkList.appendChild(li);
        });
      };

      const addHomework = (text) => {
        const t = (text||'').trim();
        if (!t) return;
        const arr = getCurrentItems();
        arr.push(t);
        renderHomeworkList(arr);
        saveData();
        newHomeworkInput.value = '';
        newHomeworkInput.focus();
      };

      // æ¨¡å¼åˆ‡æ›
      const togglePresentation = () => {
        isPresentationMode = !isPresentationMode;
        document.body.classList.toggle('presentation-mode', isPresentationMode);
        togglePresentationBtn.textContent = isPresentationMode ? 'è¿”å›ç·¨è¼¯' : 'å…¨è¢å¹•å±•ç¤º';
        if (isPresentationMode) document.documentElement.requestFullscreen?.();
        else if (document.fullscreenElement) document.exitFullscreen?.();
      };
      const toggleVertical = () => {
        isVerticalMode = !isVerticalMode;
        homeworkList.classList.toggle('vertical-mode', isVerticalMode);
        toggleVerticalBtn.textContent = isVerticalMode ? 'åˆ‡æ›æ©«æ›¸' : 'åˆ‡æ›ç›´æ›¸';
        renderHomeworkList(getCurrentItems());
      };
      const applyAndSaveFontSize = (size) => { document.documentElement.style.setProperty('--item-font-size', `${size}em`); localStorage.setItem('fontSizePreference_v20', size); };
      const loadPreferences = () => { const s = localStorage.getItem('fontSizePreference_v20'); if (s) { fontSizeSlider.value = s; applyAndSaveFontSize(s); } };

      // ç¯„æœ¬ Modal
      const initTemplateModal = () => {
        const modal = $('#template-modal');
        const showTemplateBtn = $('#show-template-btn');
        const categoryTabs = $('#category-tabs');
        const templatesGrid = $('#templates-grid');
        let isInitialized = false;
        const show = () => modal.classList.add('visible');
        const hide = () => modal.classList.remove('visible');
        const renderCategory = (cat) => {
          categoryTabs.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
          categoryTabs.querySelector(`.tab-btn[data-category="${cat}"]`)?.classList.add('active');
          templatesGrid.innerHTML='';
          (templates[cat]||[]).forEach(t => {
            const btn = document.createElement('button');
            btn.className = 'template-item';
            btn.textContent = t;
            btn.onclick = () => { addHomework(t); hide(); };
            templatesGrid.appendChild(btn);
          });
        };
        showTemplateBtn.addEventListener('click', () => {
          if (!isInitialized) {
            Object.keys(templates).forEach(cat => {
              const tab = document.createElement('button');
              tab.className='tab-btn'; tab.textContent = cat; tab.dataset.category = cat;
              tab.onclick = () => renderCategory(cat);
              categoryTabs.appendChild(tab);
            });
            renderCategory(Object.keys(templates)[0]);
            isInitialized = true;
          }
          show();
        });
        modal.addEventListener('click', e => { if (e.target === modal) hide(); });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') hide(); });
      };

      // äº‹ä»¶å§”æ´¾ï¼šåˆªé™¤ / ç·¨è¼¯å„²å­˜ / Enter è¡Œç‚º
      homeworkList.addEventListener('click', e => {
        if (e.target.classList.contains('delete-item-btn')) {
          const item = e.target.closest('.homework-item');
          const idx = $$('.homework-item').indexOf(item);
          const arr = getCurrentItems();
          arr.splice(idx,1);
          renderHomeworkList(arr);
          saveData();
        }
      });
      homeworkList.addEventListener('focusout', e => { if (e.target.classList.contains('item-content')) saveData(); });
      homeworkList.addEventListener('keydown', e => {
        if (e.target.classList.contains('item-content') && e.key === 'Enter' && !e.isComposing) { e.preventDefault(); e.target.blur(); }
      });

      // åˆå§‹åŒ–
      updateDate(currentDate);
      loadData();
      loadPreferences();
      initTemplateModal();

      // æ–°å¢äº‹é …ï¼šè™•ç†ä¸­æ–‡è¼¸å…¥æ³• Enter
      newHomeworkInput.addEventListener('keydown', e => { if (e.key==='Enter' && !e.isComposing) { e.preventDefault(); addHomework(newHomeworkInput.value); } });

      // åˆ‡æ›æ—¥æœŸï¼šå…ˆå„²å­˜ç•¶å‰å†åˆ‡æ›
      dateSelector.addEventListener('change', e => { saveData(); currentDate = e.target.value; updateDate(currentDate); loadDataForDate(currentDate); });

      // åŒ¯å‡º HTMLï¼ˆä¿ç•™åŸæ¨£å¼ï¼Œç§»é™¤ @importï¼‰
      if (exportHtmlBtn) {
        exportHtmlBtn.addEventListener('click', () => {
          const d = new Date(dateSelector.value + 'T00:00:00');
          const ts = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
          const filename = `è¯çµ¡ç°¿_${ts}.html`;
          const dateHTML = dateSelector.value.replace(/-/g,' / ');
          const weekHTML = weekDisplay.innerHTML;
          let homeworkHTML = '';
          getCurrentItems().forEach((item, i) => { if(item) homeworkHTML += `<li class="homework-item"><span class="item-index">${i+1}.</span><span class="item-content">${item}</span></li>`; });
          const rawCss = document.querySelector('style').innerHTML;
          const cssNoImport = rawCss.replace(/^[ \t]*@import[^;]+;[ \t]*$/gmi,'');
          const exportedCss = cssNoImport + `.exported-header{display:flex;justify-content:space-between;align-items:center}.exported-btn{background:var(--primary-color);color:#fff;padding:10px 18px;border-radius:10px;border:none;font-size:1em;cursor:pointer}`;
          const exportedJs = `<script>document.addEventListener('DOMContentLoaded',()=>{const b=document.getElementById('fullscreen-btn');b.addEventListener('click',()=>{if(!document.fullscreenElement){document.documentElement.requestFullscreen?.();b.textContent='çµæŸå…¨è¢å¹•'}else{document.exitFullscreen?.();b.textContent='å…¨è¢å¹•å±•ç¤º'}});});<\/script>`;
          const html = `<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><title>${filename}</title><style>${exportedCss}</style></head><body><div class="container"><div class="exported-header"><h1 class="main-title">æ™ºæ…§è¯çµ¡ç°¿</h1><button id=\"fullscreen-btn\" class=\"exported-btn\">å…¨è¢å¹•å±•ç¤º</button></div><div class="card"><div class="card-header"><div style=\"font-size:2.2em;font-weight:700;\">${dateHTML}</div><div style=\"font-size:1.2em;color:var(--text-color-secondary);\">${weekHTML}</div></div><ul class="homework-list">${homeworkHTML}</ul></div></div>${exportedJs}</body></html>`;
          const a = document.createElement('a');
          a.href = 'data:text/html;charset=utf-8,' + encodeURIComponent(html);
          a.download = filename;
          a.click();
        });
      }

      // åŒ¯å‡ºå¡ç‰‡ PNG
      exportPngBtn.addEventListener('click', async () => {
        if (typeof html2canvas !== 'function') return alert('åŒ¯å‡ºæ¨¡çµ„æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
        const d = new Date(dateSelector.value + 'T00:00:00');
        const ts = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const old = exportPngBtn.textContent; exportPngBtn.disabled = true; exportPngBtn.textContent = 'åŒ¯å‡ºä¸­â€¦';
        try{
          const node = $('#main-card');
          const canvas = await html2canvas(node,{ scale:Math.min(window.devicePixelRatio||1,3), useCORS:true, backgroundColor:null, logging:false, onclone:(doc)=>{ const c=doc.querySelector('#main-card'); if(c){ c.style.maxHeight='none'; const list=c.querySelector('#homework-list'); if(list) list.style.overflow='visible'; } } });
          const a=document.createElement('a'); a.download=`è¯çµ¡ç°¿_${ts}.png`; a.href=canvas.toDataURL('image/png'); a.click();
        }catch(e){ alert('åŒ¯å‡ºåœ–ç‰‡å¤±æ•—ï¼š'+(e?.message||e)); }
        finally{ exportPngBtn.disabled=false; exportPngBtn.textContent=old; }
      });

      // åŒ¯å‡ºæ•´é  PNGï¼ˆç´”è‰²èƒŒæ™¯ï¼Œé¿å…å¤–éƒ¨èƒŒæ™¯ CORSï¼‰
      exportFullPngBtn.addEventListener('click', async () => {
        if (typeof html2canvas !== 'function') return alert('åŒ¯å‡ºæ¨¡çµ„æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
        const d = new Date(dateSelector.value + 'T00:00:00');
        const ts = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const old = exportFullPngBtn.textContent; exportFullPngBtn.disabled = true; exportFullPngBtn.textContent = 'åŒ¯å‡ºä¸­â€¦';
        try{
          const node = $('.container');
          const canvas = await html2canvas(node,{ scale:Math.min(window.devicePixelRatio||1,2.5), useCORS:true, backgroundColor:'#3D4A45', logging:false, onclone:(doc)=>{ doc.body.style.backgroundImage='none'; doc.body.style.background='#3D4A45'; const c=doc.querySelector('#main-card'); if(c){ c.style.maxHeight='none'; const list=c.querySelector('#homework-list'); if(list) list.style.overflow='visible'; } const modal=doc.getElementById('template-modal'); if(modal) modal.classList.remove('visible'); } });
          const a=document.createElement('a'); a.download=`è¯çµ¡ç°¿æ•´é _${ts}.png`; a.href=canvas.toDataURL('image/png'); a.click();
        }catch(e){ alert('åŒ¯å‡ºæ•´é åœ–ç‰‡å¤±æ•—ï¼š'+(e?.message||e)); }
        finally{ exportFullPngBtn.disabled=false; exportFullPngBtn.textContent=old; }
      });

      // å…¶ä»–æ§åˆ¶
      togglePresentationBtn.addEventListener('click', togglePresentation);
      document.addEventListener('fullscreenchange', () => { if (!document.fullscreenElement && isPresentationMode) togglePresentation(); });
      toggleVerticalBtn.addEventListener('click', toggleVertical);
      fontSizeSlider.addEventListener('input', e => applyAndSaveFontSize(e.target.value));
    });
  </script>
</body>
</html>
