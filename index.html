<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>智慧聯絡簿 v20.6（日期切換＋精簡功能＋大版面）</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root{
      --primary-color:#87CEEB;
      --card-bg:#000;
      --card-border:rgba(255,255,255,.2);
      --text-color-primary:#fff;
      --text-color-secondary:rgba(255,255,255,.75);
      --input-bg:rgba(0,0,0,.35);
      --shadow-color:rgba(0,0,0,.4);
      --control-border-radius:12px;
      --item-font-size:1.65em;
    }
    body{margin:0;height:100%;display:flex;align-items:center;justify-content:center;
      background:#3D4A45;font-family:'Microsoft JhengHei','Noto Sans TC',sans-serif;color:var(--text-color-primary);}
    .container{max-width:1100px;width:100%}
    .card{background:var(--card-bg);border:1px solid var(--card-border);
      border-radius:24px;padding:40px;min-height:700px;box-shadow:0 15px 50px rgba(0,0,0,.5)}
    .card-header{text-align:center;margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--card-border);}
    #date-nav{display:flex;justify-content:center;align-items:center;gap:15px;margin-bottom:10px}
    #date-selector{background:none;border:none;color:var(--text-color-primary);font-size:2em;font-weight:700;text-align:center;cursor:pointer}
    #week-display{font-size:1.2em;color:var(--text-color-secondary)}
    .homework-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:14px;flex-grow:1}
    .homework-item{font-size:var(--item-font-size);display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--control-border-radius);}
    .item-index{color:var(--text-color-secondary)}
    #homework-input-area{display:flex;margin-top:20px;background:var(--input-bg);border-radius:var(--control-border-radius);}
    #new-homework-input{flex-grow:1;background:none;border:none;padding:14px 18px;font-size:1.2em;color:var(--text-color-primary);}
    .add-btn{background:var(--primary-color);border:none;padding:12px 16px;border-radius:var(--control-border-radius);}
    .footer-buttons{display:flex;flex-wrap:wrap;justify-content:center;gap:12px;margin-top:20px}
    button{cursor:pointer;border:none;border-radius:var(--control-border-radius);padding:10px 14px;font-weight:600}
    .btn-primary{background:var(--primary-color);color:#111}
    .btn-secondary{background:rgba(255,255,255,.15);color:#fff}
    .btn-danger{background:rgba(255,86,86,.18);color:#ffd3d3;border:1px solid rgba(255,86,86,.35)}
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="main-card">
      <div class="card-header">
        <div id="date-nav">
          <button id="prev-day-btn" class="btn-secondary">◀ 前一天</button>
          <input type="date" id="date-selector">
          <button id="next-day-btn" class="btn-secondary">後一天 ▶</button>
        </div>
        <div id="week-display"></div>
      </div>
      <ul class="homework-list" id="homework-list"></ul>
      <div id="homework-input-area">
        <input type="text" id="new-homework-input" placeholder="新增事項...">
        <button id="add-item-btn" class="add-btn">➕</button>
      </div>
    </div>

    <div class="footer-buttons">
      <button id="toggle-vertical-btn" class="btn-secondary">切換直書</button>
      <button id="toggle-presentation-btn" class="btn-secondary">全螢幕展示</button>
      <button id="export-png-btn" class="btn-primary">匯出圖片（PNG）</button>
      <button id="export-fullpng-btn" class="btn-secondary">匯出整頁（PNG）</button>
      <button id="copy-text-btn" class="btn-secondary">複製文字</button>
      <button id="copy-prev-btn" class="btn-secondary">複製前日</button>
      <button id="clear-today-btn" class="btn-danger">清空今日</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded',()=>{
      const $=s=>document.querySelector(s);
      const $$=s=>Array.from(document.querySelectorAll(s));
      const dateSelector=$('#date-selector');
      const weekDisplay=$('#week-display');
      const homeworkList=$('#homework-list');
      const addItemBtn=$('#add-item-btn');
      const newHomeworkInput=$('#new-homework-input');
      const prevDayBtn=$('#prev-day-btn');
      const nextDayBtn=$('#next-day-btn');
      const exportPngBtn=$('#export-png-btn');
      const exportFullPngBtn=$('#export-fullpng-btn');
      const copyTextBtn=$('#copy-text-btn');
      const copyPrevBtn=$('#copy-prev-btn');

      let allData={},today=new Date();
      const pad=n=>String(n).padStart(2,'0');
      let currentDate=`${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;

      const saveData=()=>{allData[currentDate]=getItems();localStorage.setItem('contactbook',JSON.stringify(allData));};
      const loadData=()=>{try{allData=JSON.parse(localStorage.getItem('contactbook'))||{}}catch{};render(allData[currentDate]||[]);}
      const getItems=()=>$$( '.item-content').map(el=>el.textContent.trim()).filter(Boolean);
      const updateDate=(ds)=>{const d=new Date(ds+'T00:00:00');weekDisplay.textContent=['日','一','二','三','四','五','六'][d.getDay()];dateSelector.value=ds;};
      const render=(arr)=>{homeworkList.innerHTML=arr.length?arr.map((t,i)=>`<li class="homework-item"><span class="item-index">${i+1}.</span><span class="item-content" contenteditable>${t}</span></li>`).join(''):`<p>點擊下方輸入框新增今日聯絡事項</p>`;};

      function changeDay(offset){const d=new Date(currentDate+'T00:00:00');d.setDate(d.getDate()+offset);currentDate=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;updateDate(currentDate);render(allData[currentDate]||[]);}
      prevDayBtn.onclick=()=>{saveData();changeDay(-1);};
      nextDayBtn.onclick=()=>{saveData();changeDay(+1);};

      addItemBtn.onclick=()=>{if(!newHomeworkInput.value.trim())return;const arr=getItems();arr.push(newHomeworkInput.value.trim());render(arr);saveData();newHomeworkInput.value='';};

      copyTextBtn.onclick=async()=>{const items=getItems().map((t,i)=>`${i+1}. ${t}`).join('\n');await navigator.clipboard.writeText(items||'');alert('已複製');};
      copyPrevBtn.onclick=()=>{const d=new Date(currentDate+'T00:00:00');d.setDate(d.getDate()-1);const prev=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;if(!allData[prev]||!allData[prev].length)return alert('前一天沒有資料');render(allData[prev]);saveData();};

      // 匯出圖片
      async function exportImg(node,filename,bg){const canvas=await html2canvas(node,{backgroundColor:bg,scale:2});const a=document.createElement('a');a.download=filename;a.href=canvas.toDataURL();a.click();}
      exportPngBtn.onclick=()=>exportImg($('#main-card'),`聯絡簿_${currentDate}.png`,'#3D4A45');
      exportFullPngBtn.onclick=()=>exportImg($('.container'),`聯絡簿整頁_${currentDate}.png`,'#3D4A45');

      updateDate(currentDate);loadData();
    });
  </script>
</body>
</html>
